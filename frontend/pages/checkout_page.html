<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - SaiKrupa Paithani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="nav.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#800000",
              primaryLight: "#b30000",
              gold: "#D4AF37",
              lightGold: "#F2E8C9",
              cream: "#F8F4E3",
              darkRed: "#680000",
              gray: "#777",
              lightGray: "#f5f5f5",
              white: "#ffffff",
              black: "#333333",
            },
          },
        },
      };
    </script>
    <style>
  
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f4e3;
      }
      .checkout-step {
        transition: all 0.3s ease;
      }
      .checkout-step.active {
        border-color: #d4af37;
        background-color: #f8f4e3;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.95);
        color: #800000;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 15px rgba(128, 0, 0, 0.1);
        height: 80px;
      }
      nav ul {
        display: flex;
        list-style: none;
      }
      nav ul li {
        position: relative;
        margin: 0 15px;
      }
      nav ul li a {
        color: #800000;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        padding: 10px 5px;
        display: block;
        position: relative;
      }
      nav ul li a:after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #800000;
        left: 0;
        bottom: 0;
        transition: width 0.3s ease;
      }
      nav ul li a:hover:after {
        width: 100%;
      }
      .nav-icons {
        display: flex;
        align-items: center;
      }
      .nav-icon {
        color: #800000;
        font-size: 1.3rem;
        margin-left: 20px;
        position: relative;
        cursor: pointer;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #800000;
        color: white;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 20px;
        color: #800000;
      }
      .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .payment-method:hover {
        border-color: #d4af37;
      }
      .payment-method.selected {
        border-color: #800000;
        background-color: #f8f4e3;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 20px;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .step.active .step-number {
        background: #800000;
        color: white;
      }
      .step.completed .step-number {
        background: #d4af37;
        color: white;
      }
      .step-text {
        font-size: 0.9rem;
        color: #777;
      }
      .step.active .step-text {
        color: #800000;
        font-weight: 600;
      }
      .loading-spinner {
        display: none;
      }
      .loading-spinner.active {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .qr-code-container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 900px) {
        nav ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          background: rgba(255, 255, 255, 0.98);
          flex-direction: column;
          padding: 20px;
        }
        nav ul.show {
          display: flex;
        }
        nav ul li {
          margin: 10px 0;
          width: 100%;
          text-align: center;
        }
        .hamburger {
          display: block;
        }
      }
    </style>
</head>
<body class="bg-cream">

    <nav>
      <a href="dashboard.html" class="logo flex items-center font-bold text-darkRed">
        <img src="images/logo3.png" alt="Paithani Logo" class="logo-img h-20 w-20 rounded-full mr-3" />
        <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
      </a>
      <ul>
          <li><a href="dashboard.html">Home</a></li>
        <li><a href="product.html">Collections</a></li>
        <li><a href="#testimonials">Testimonials</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-icons">
        <a href="history.html"><div class="nav-icon"><i class="fas fa-shipping-fast mr-2"></i></div></a>
        <div class="nav-icon">
          <a href="cart.html"
            ><i class="fas fa-shopping-cart"></i
            ><span class="cart-count" id="headerCartCount">0</span></a
          >
        </div>
        <div class="hamburger">&#9776;</div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-4 text-gray">
      <a href="dashboard.html"
        ><span class="hover:text-primary cursor-pointer">Home</span> /
      </a>
      <a href="cart.html"
        ><span class="hover:text-primary cursor-pointer">Cart</span> /
      </a>
      <span class="text-primary">Checkout</span>
    </div>

    <div class="container mx-auto px-6 py-6">
      <div class="step-indicator">
        <div class="step completed">
          <div class="step-number"><i class="fas fa-check"></i></div>
          <div class="step-text">Cart</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-text">Information</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">Shipping</div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">Payment</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Checkout</h1>
      <p class="text-gray mb-8">Complete your purchase with secure checkout</p>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <form id="checkoutForm">
           
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step active">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">1</div>
                <h2 class="text-xl font-semibold text-primary">Contact Information</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
                <div>
                  <label for="phone" class="block text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="newsletter" class="mr-2" />
                <label for="newsletter" class="text-gray-700">Email me with news and offers</label>
              </div>
            </div>

            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">2</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Address</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="firstName" class="block text-gray-700 mb-2">First Name *</label><input type="text" id="firstName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="lastName" class="block text-gray-700 mb-2">Last Name *</label><input type="text" id="lastName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div class="md:col-span-2"><label for="address" class="block text-gray-700 mb-2">Address *</label><input type="text" id="address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="city" class="block text-gray-700 mb-2">City *</label><input type="text" id="city" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div>
                  <label for="state" class="block text-gray-700 mb-2">State *</label>
                  <select id="state" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <option value="">Select State</option>
                    <option value="MH">Maharashtra</option>
                    <option value="DL">Delhi</option>
                    <option value="KA">Karnataka</option>
                    <option value="TN">Tamil Nadu</option>
                    <option value="GJ">Gujarat</option>
                    <option value="UP">Uttar Pradesh</option>
                    <option value="WB">West Bengal</option>
                  </select>
                </div>
                <div><label for="pincode" class="block text-gray-700 mb-2">PIN Code *</label><input type="text" id="pincode" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="saveAddress" class="mr-2" />
                <label for="saveAddress" class="text-gray-700">Save this information for next time</label>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">3</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Method</h2>
              </div>
              <div class="space-y-4">
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="standard" name="shipping" value="standard" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="standard" class="font-medium">Standard Shipping</label>
                      <p class="text-gray text-sm">5-7 business days ‚Ä¢ ‚Çπ200</p>
                    </div>
                    <span class="font-semibold">‚Çπ200</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="express" name="shipping" value="express" class="mr-3" />
                    <div class="flex-1">
                      <label for="express" class="font-medium">Express Shipping</label>
                      <p class="text-gray text-sm">2-3 business days ‚Ä¢ ‚Çπ500</p>
                    </div>
                    <span class="font-semibold">‚Çπ500</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="free" name="shipping" value="free" class="mr-3" />
                    <div class="flex-1">
                      <label for="free" class="font-medium">Free Shipping</label>
                      <p class="text-gray text-sm">7-10 business days ‚Ä¢ Free on orders above ‚Çπ10,000</p>
                    </div>
                    <span class="font-semibold text-green-600">FREE</span>
                  </div>
                </div>
              </div>
            </div>

         
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step" id="paymentSection">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">4</div>
                <h2 class="text-xl font-semibold text-primary">Payment Method</h2>
              </div>

              <div class="space-y-4">
             
                <div class="payment-method selected" id="razorpayPayment">
                  <div class="flex items-center">
                    <input type="radio" id="razorpay" name="payment" value="razorpay" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="razorpay" class="font-medium">Secure Payment via Razorpay</label>
                      <p class="text-gray text-sm">Pay securely using Credit/Debit Card, UPI, Net Banking, or Wallet</p>
                      <div class="flex space-x-2 mt-3">
                        <div class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">RAZORPAY</div>
                        <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                        <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                        <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                        <i class="fab fa-google-pay text-2xl text-gray-500"></i>
                        <i class="fab fa-amazon-pay text-2xl text-gray-500"></i>
                        <i class="fas fa-mobile-alt text-2xl text-gray-500"></i>
                      </div>
                    </div>
                  </div>
                </div>

            
                <div class="payment-method" id="qrPayment">
                  <div class="flex items-center">
                    <input type="radio" id="qr" name="payment" value="qr" class="mr-3" />
                    <div class="flex-1">
                      <label for="qr" class="font-medium">Pay via UPI QR Code</label>
                      <p class="text-gray text-sm">Scan QR code with any UPI app to pay instantly</p>
                      <div id="qrCodeContainer" class="mt-3 hidden">
                        <div class="qr-code-container">
                          <div id="qrcode" class="mx-auto mb-3"></div>
                          <p class="text-sm text-gray-600 mb-2">Scan this QR code with your UPI app</p>
                          <p class="text-xs text-gray-500 bg-lightGold p-2 rounded" id="upiId">your-upi-id@bank</p>
                          <p class="text-sm font-semibold text-primary mt-2">Amount: ‚Çπ<span id="qrAmount">0</span></p>
                          <button type="button" id="refreshQR" class="text-primary text-sm mt-2 hover:text-darkRed">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh QR Code
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                
                <div class="payment-method" id="codPayment">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment" value="cod" class="mr-3" />
                    <div class="flex-1">
                      <label for="cod" class="font-medium">Cash on Delivery</label>
                      <p class="text-gray text-sm">Pay when you receive your order (Additional ‚Çπ50 COD charges apply)</p>
                    </div>
                  </div>
                </div>
              </div>

           
              <div class="mt-6 p-4 bg-lightGold rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt text-primary text-xl mr-3"></i>
                  <div>
                    <h4 class="font-semibold text-primary">Your payment is secure with Razorpay</h4>
                    <p class="text-sm text-gray">All transactions are encrypted and secure. We do not store your payment details.</p>
                  </div>
                </div>
              </div>

             
              <div id="razorpayButtonContainer" class="mt-6">
                <button type="button" id="payButton" class="w-full bg-primary hover:bg-darkRed text-white py-4 px-6 rounded-lg font-semibold text-lg flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-lock mr-2"></i>
                  Pay Securely - ‚Çπ<span id="payAmount">0</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2">You will be redirected to Razorpay secure payment page</p>
              </div>

            
              <div id="upiInstructions" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                <h4 class="font-semibold text-blue-800 mb-2">How to pay with UPI QR Code:</h4>
                <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                  <li>Open your UPI app (Google Pay, PhonePe, Paytm, etc.)</li>
                  <li>Tap on 'Scan QR Code'</li>
                  <li>Scan the QR code above</li>
                  <li>Verify the amount and merchant details</li>
                  <li>Enter your UPI PIN to complete payment</li>
                </ol>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <a href="cart.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Cart
              </a>
              <button type="submit" id="submitOrder" class="bg-primary hover:bg-darkRed text-white py-3 px-8 rounded-lg font-semibold text-lg flex items-center">
                <span id="submitText">Complete Order</span>
                <i class="fas fa-lock ml-2"></i>
                <i class="fas fa-spinner loading-spinner ml-2"></i>
              </button>
            </div>
          </form>
        </div>

        <div class="lg:w-1/3">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-primary mb-4">Order Summary</h2>
            <div class="mb-6 max-h-80 overflow-y-auto" id="orderItemsContainer"></div>
            <div class="space-y-3 mb-6" id="orderSummary">
              <div class="flex justify-between">
                <span class="text-gray">Subtotal (<span id="summaryItemCount">0</span> items)</span>
                <span class="font-medium" id="subtotalAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Shipping</span>
                <span class="font-medium" id="shippingAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Tax</span>
                <span class="font-medium" id="taxAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-green-600" id="discountSection" style="display: none">
                <span>Discount</span>
                <span id="discountAmount">-‚Çπ0</span>
              </div>
              <div class="flex justify-between text-orange-600" id="codChargesSection" style="display: none">
                <span>COD Charges</span>
                <span id="codChargesAmount">‚Çπ50</span>
              </div>
              <div class="border-t pt-3 flex justify-between text-lg font-bold">
                <span>Total</span>
                <span class="text-primary" id="totalAmount">‚Çπ0</span>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-center mb-3">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                <span class="text-sm font-medium">100% Secure Checkout</span>
              </div>
              <div class="flex justify-center space-x-4">
                <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                <i class="fab fa-cc-paypal text-2xl text-gray-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Need Help?</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <i class="fas fa-phone text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Call Us</p>
                  <p class="text-sm text-gray">+91 98765 43210</p>
                </div>
              </div>
              <div class="flex items-center">
                <i class="fas fa-comments text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Chat with Us</p>
                  <p class="text-sm text-gray">Available 24/7</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-primary text-white mt-12 py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">SaiKrupa Paithani</h3>
            <p class="text-lightGold">Bringing traditional Maharashtrian elegance to your doorstep with authentic handwoven Paithani sarees.</p>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">About Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Collections</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Shipping Policy</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Return Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">Contact Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">FAQs</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Track Order</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Newsletter</h4>
            <p class="text-lightGold mb-4">Subscribe to get special offers and once-in-a-lifetime deals.</p>
            <div class="flex">
              <input type="email" placeholder="Your email" class="px-4 py-2 rounded-l-lg w-full text-black" />
              <button class="bg-gold text-black px-4 py-2 rounded-r-lg font-semibold">Subscribe</button>
            </div>
          </div>
        </div>
        <div class="border-t border-primaryLight mt-8 pt-8 text-center">
          <p>¬© 2025 SaiKrupa Paithani. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script>
     
      let cartItems = [];
      let orderTotals = {
        subtotal: 0,
        shipping: 0,
        tax: 0,
        discount: 0,
        codCharges: 0,
        total: 0,
      };
      let razorpayOrderId = null;
      let isProcessingPayment = false;

    
      const YOUR_UPI_ID = "rahulbhandge@ybl"; 

    
      function getAuthToken() {
        return localStorage.getItem("authToken") || localStorage.getItem("token");
      }

      function checkAuth() {
        const token = getAuthToken();
        if (!token) {
          alert("Please login to proceed with checkout");
          window.location.href = "signup_login.html";
          return false;
        }
        return true;
      }

      function showSuccessMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

      function showErrorMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

 
      async function sendOrderConfirmationEmail(orderData, orderId, orderNumber, paymentMethod) {
        try {
          const token = getAuthToken();
          const customerEmail = document.getElementById("email").value;
          
          const emailData = {
            to: customerEmail,
            subject: paymentMethod === 'cod' 
              ? `Order Confirmed - Your SaiKrupa Paithani Order #${orderNumber}`
              : `Payment Successful - Your SaiKrupa Paithani Order #${orderNumber}`,
            orderId: orderId,
            orderNumber: orderNumber,
            customerName: `${document.getElementById("firstName").value} ${document.getElementById("lastName").value}`,
            orderData: orderData,
            paymentMethod: paymentMethod,
            totalAmount: orderTotals.total
          };

          console.log("üìß Sending email notification:", emailData);

          const response = await fetch('http://localhost:5000/api/email/send-order-confirmation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(emailData)
          });

          const result = await response.json();
          
          if (result.success) {
            console.log("‚úÖ Email sent successfully");
          } else {
            console.warn("‚ö†Ô∏è Email sending failed:", result.message);
          }
        } catch (error) {
          console.error("‚ùå Email sending error:", error);
        }
      }

 
      async function fetchCart() {
        if (!checkAuth()) return;

        try {
          const token = getAuthToken();
          console.log("üîÑ Fetching cart data...");

          const res = await fetch("http://localhost:5000/api/cart", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem("authToken");
              localStorage.removeItem("token");
              window.location.href = "signup_login.html";
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const result = await res.json();
          console.log("üì¶ Cart API response:", result);

          if (result.success && result.cart) {
            cartItems = result.cart.items.map((item) => {
              const product = item.productId;
              return {
                productId: product._id,
                name: product.name || "Product",
                image: product.images?.[0] || "images/default.jpg",
                price: item.price || product.price || 0,
                quantity: item.quantity || 1,
              };
            });

            console.log("üõí Processed cart items:", cartItems);

            if (cartItems.length === 0) {
              showErrorMessage("Your cart is empty");
              setTimeout(() => {
                window.location.href = "cart.html";
              }, 2000);
              return;
            }

            renderOrderItems();
            updateOrderSummary();
            updateCartCount();
          } else {
            throw new Error(result.message || "Failed to fetch cart");
          }
        } catch (err) {
          console.error("‚ùå Fetch cart error:", err);
          showErrorMessage("Failed to load cart items: " + err.message);
        }
      }

      function renderOrderItems() {
        const container = document.getElementById("orderItemsContainer");
        container.innerHTML = cartItems.map((item) => {
          const itemTotal = item.price * item.quantity;
          return `
            <div class="flex border-b border-gray-200 py-4">
              <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex items-center justify-center">
                <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-primary">${item.name}</h3>
                <p class="text-gray text-sm">Qty: ${item.quantity}</p>
                <p class="text-primary font-semibold">‚Çπ${itemTotal.toLocaleString()}</p>
              </div>
            </div>
          `;
        }).join("");
      }

      function updateOrderSummary() {
        const subtotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

        const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
        let shipping = 0;
        if (shippingMethod === "express") shipping = 500;
        else if (shippingMethod === "standard") shipping = 200;
        else if (shippingMethod === "free") shipping = subtotal > 10000 ? 0 : 200;

        const tax = Math.round(subtotal * 0.02);
        const discount = subtotal > 5000 ? Math.round(subtotal * 0.1) : 0;
        
     
        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
        const codCharges = paymentMethod === 'cod' ? 50 : 0;
        
        const total = subtotal + shipping + tax - discount + codCharges;

        orderTotals = { subtotal, shipping, tax, discount, codCharges, total };

        document.getElementById("summaryItemCount").textContent = itemCount;
        document.getElementById("subtotalAmount").textContent = `‚Çπ${subtotal.toLocaleString()}`;
        document.getElementById("shippingAmount").textContent = shipping === 0 ? "FREE" : `‚Çπ${shipping}`;
        document.getElementById("taxAmount").textContent = `‚Çπ${tax.toLocaleString()}`;
        document.getElementById("totalAmount").textContent = `‚Çπ${total.toLocaleString()}`;

      
        const discountSection = document.getElementById("discountSection");
        const discountAmount = document.getElementById("discountAmount");
        if (discount > 0) {
          discountSection.style.display = "flex";
          discountAmount.textContent = `-‚Çπ${discount.toLocaleString()}`;
        } else {
          discountSection.style.display = "none";
        }

   
        const codSection = document.getElementById("codChargesSection");
        if (codCharges > 0) {
          codSection.style.display = "flex";
        } else {
          codSection.style.display = "none";
        }

  
        if (document.getElementById('payAmount')) {
          document.getElementById('payAmount').textContent = total.toLocaleString();
        }
        if (document.getElementById('qrAmount')) {
          document.getElementById('qrAmount').textContent = total.toLocaleString();
        }
      }

      function updateCartCount() {
        const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("headerCartCount").textContent = totalItems;
      }

      function getShippingAddress() {
        return {
          firstName: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          email: document.getElementById("email").value,
          phone: document.getElementById("phone").value,
          address: document.getElementById("address").value,
          city: document.getElementById("city").value,
          state: document.getElementById("state").value,
          pincode: document.getElementById("pincode").value,
        };
      }

      function validateForm() {
        const requiredFields = [
          "email", "phone", "firstName", "lastName", "address", "city", "state", "pincode",
        ];
        for (let field of requiredFields) {
          const el = document.getElementById(field);
          if (!el.value.trim()) {
            showErrorMessage(`Please fill in the ${field}`);
            el.focus();
            return false;
          }
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(document.getElementById("email").value)) {
          showErrorMessage("Invalid email");
          return false;
        }

        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(document.getElementById("phone").value.replace(/\D/g, ""))) {
          showErrorMessage("Invalid 10-digit phone number");
          return false;
        }

        return true;
      }

 
      function generateQRCode() {
        try {
          const totalAmount = orderTotals.total;
          const upiId = YOUR_UPI_ID;
          
          console.log("üîç Generating QR for UPI:", upiId, "Amount:", totalAmount);
          
       
          const upiUrl = `upi://pay?pa=${upiId}&pn=SaiKrupa%20Paithani&am=${totalAmount}&cu=INR&tn=Payment%20for%20Paithani%20Order`;
          
          console.log("üîó Final UPI URL:", upiUrl);
          
          const qrcodeElement = document.getElementById('qrcode');
          qrcodeElement.innerHTML = '';
          
          
          const qr = qrcode(0, 'M');
          qr.addData(upiUrl);
          qr.make();
          
          const qrSvg = qr.createSvgTag({
            scalable: true,
            margin: 2
          });
          
          qrcodeElement.innerHTML = qrSvg;
          
          document.getElementById('upiId').textContent = upiId;
          document.getElementById('qrAmount').textContent = totalAmount.toLocaleString();
          
          console.log("‚úÖ QR code generated successfully");
          
        } catch (error) {
          console.error("‚ùå QR code error:", error);
 
          const qrcodeElement = document.getElementById('qrcode');
          qrcodeElement.innerHTML = `
            <div class="text-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
              <p class="text-green-600 font-semibold mb-2">Manual UPI Payment</p>
              <p class="text-sm mb-1">Send payment to:</p>
              <p class="font-mono bg-gray-100 p-3 rounded text-lg font-bold border">${YOUR_UPI_ID}</p>
              <p class="text-lg font-semibold text-primary mt-2">Amount: ‚Çπ${orderTotals.total.toLocaleString()}</p>
              <div class="mt-3 text-left text-sm bg-yellow-50 p-3 rounded">
                <p class="font-semibold">Instructions:</p>
                <ol class="list-decimal list-inside mt-1">
                  <li>Open Google Pay, PhonePe, or any UPI app</li>
                  <li>Tap "Send Money" or "Pay"</li>
                  <li>Enter: <strong>${YOUR_UPI_ID}</strong></li>
                  <li>Amount: <strong>‚Çπ${orderTotals.total.toLocaleString()}</strong></li>
                  <li>Add note: "Paithani Order"</li>
                  <li>Complete payment</li>
                </ol>
              </div>
              <p class="text-xs text-gray-500 mt-2">After payment, share screenshot for order confirmation</p>
            </div>
          `;
        }
      }

   
      function handlePaymentMethodChange() {
        const selectedMethod = document.querySelector('input[name="payment"]:checked').value;
        
     
        if (selectedMethod === 'razorpay') {
            document.getElementById('razorpayButtonContainer').classList.remove('hidden');
            document.getElementById('qrCodeContainer').classList.add('hidden');
            document.getElementById('upiInstructions').classList.add('hidden');
            initializeRazorpayPayment();
        } else if (selectedMethod === 'qr') {
            document.getElementById('razorpayButtonContainer').classList.add('hidden');
            document.getElementById('qrCodeContainer').classList.remove('hidden');
            document.getElementById('upiInstructions').classList.remove('hidden');
            generateQRCode();
        } else if (selectedMethod === 'cod') {
            document.getElementById('razorpayButtonContainer').classList.add('hidden');
            document.getElementById('qrCodeContainer').classList.add('hidden');
            document.getElementById('upiInstructions').classList.add('hidden');
        }
        
        updateOrderSummary();
      }

      async function initializeRazorpayPayment() {
        try {
          const totalAmount = orderTotals.total;
          document.getElementById('payAmount').textContent = totalAmount.toLocaleString();
          
         
          const token = getAuthToken();
          const response = await fetch('http://localhost:5000/api/payments/create-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              amount: totalAmount,
              currency: 'INR',
              receipt: `receipt_${Date.now()}`
            })
          });

          const result = await response.json();
          
          if (result.success) {
            razorpayOrderId = result.order.id;
            console.log("‚úÖ Razorpay order initialized:", razorpayOrderId);
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error("‚ùå Razorpay initialization error:", error);
          showErrorMessage("Failed to initialize payment: " + error.message);
        }
      }

      async function initiateRazorpayPayment() {
        if (isProcessingPayment) return;
        
        try {
          isProcessingPayment = true;
          const payButton = document.getElementById('payButton');
          const originalText = payButton.innerHTML;
          
          payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
          payButton.disabled = true;

          const token = getAuthToken();
          const response = await fetch('http://localhost:5000/api/payments/create-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              amount: orderTotals.total,
              currency: 'INR',
              receipt: `receipt_${Date.now()}`
            })
          });

          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.message);
          }

          const options = {
            key: 'rzp_test_Rg2ZENKibKx5N2',
            amount: result.order.amount,
            currency: result.order.currency,
            name: "SaiKrupa Paithani",
            description: "Purchase of Paithani Products",
            order_id: result.order.id,
            handler: async function(response) {
              await handlePaymentSuccess(response);
            },
            prefill: {
              name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
              email: document.getElementById('email').value,
              contact: document.getElementById('phone').value
            },
            notes: {
              address: "SaiKrupa Paithani Store"
            },
            theme: {
              color: "#800000"
            },
            modal: {
              ondismiss: function() {
                isProcessingPayment = false;
                payButton.innerHTML = originalText;
                payButton.disabled = false;
                console.log("Payment modal closed");
              }
            }
          };

          const rzp = new Razorpay(options);
          rzp.open();
          
        } catch (error) {
          console.error("‚ùå Payment initiation error:", error);
          showErrorMessage("Failed to initiate payment: " + error.message);
          isProcessingPayment = false;
          
          const payButton = document.getElementById('payButton');
          payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          payButton.disabled = false;
        }
      }


      async function handlePaymentSuccess(paymentResponse) {
        try {
          console.log("‚úÖ Payment successful:", paymentResponse);
          
          const token = getAuthToken();
          
      
          const verifyResponse = await fetch('http://localhost:5000/api/payments/verify-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              razorpay_order_id: paymentResponse.razorpay_order_id,
              razorpay_payment_id: paymentResponse.razorpay_payment_id,
              razorpay_signature: paymentResponse.razorpay_signature
            })
          });

       
          if (!verifyResponse.ok) {
            if (verifyResponse.status === 404) {
              console.warn("‚ö†Ô∏è Payment verification endpoint not found, proceeding with order creation...");
            
              await createOrderWithPayment('razorpay', paymentResponse);
              return;
            }
            throw new Error(`HTTP error! status: ${verifyResponse.status}`);
          }

          const result = await verifyResponse.json();
          
          if (result.success) {
            showSuccessMessage("Payment verified successfully! Creating your order...");
            await createOrderWithPayment('razorpay', paymentResponse);
          } else {
            throw new Error("Payment verification failed");
          }
        } catch (error) {
          console.error("‚ùå Payment verification error:", error);
        
          if (error.message.includes('404') || error.message.includes('JSON')) {
            showErrorMessage("Payment verification service unavailable. Creating order anyway...");
            await createOrderWithPayment('razorpay', paymentResponse);
          } else {
            showErrorMessage("Payment verification failed: " + error.message);
          }
        } finally {
          isProcessingPayment = false;
        }
      }

   
      async function createOrderWithPayment(paymentMethod, paymentResponse = null) {
        const submitBtn = document.getElementById("submitOrder");
        const submitText = document.getElementById("submitText");
        const spinner = document.querySelector(".loading-spinner");

        try {
          console.log("=== STARTING ORDER CREATION WITH PAYMENT ===");

          const token = getAuthToken();
          if (!token) {
            showErrorMessage("Please login first");
            return;
          }

          if (!cartItems || cartItems.length === 0) {
            showErrorMessage("Your cart is empty");
            return;
          }

          const shippingAddress = getShippingAddress();
          const orderData = {
            shippingAddress: shippingAddress,
            paymentMethod: paymentMethod,
            shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
            items: cartItems,
            paymentResponse: paymentResponse 
          };

          console.log("üì¶ Final Order Data:", orderData);

          const response = await fetch("http://localhost:5000/api/orders/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });

          const responseText = await response.text();
          console.log("üì® Raw Response:", responseText);

          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error("‚ùå JSON Parse Error:", parseError);
            throw new Error("Server returned invalid JSON: " + responseText);
          }

          if (result.success) {
            console.log("‚úÖ ORDER CREATED SUCCESSFULLY! Order ID:", result.order._id);
            showSuccessMessage("Order placed successfully!");

       
            await sendOrderConfirmationEmail(
              orderData, 
              result.order._id, 
              result.order.orderNumber, 
              paymentMethod
            );

            setTimeout(() => {
              window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
            }, 2000);
          } else {
            throw new Error(result.message || "Failed to create order");
          }
        } catch (err) {
          console.error("üí• FINAL ERROR:", err);
          showErrorMessage("Failed to place order: " + err.message);
        } finally {
          submitBtn.disabled = false;
          submitText.textContent = "Complete Order";
          spinner.style.display = "none";
        }
      }

    
      async function createOrder(paymentMethod) {
        await createOrderWithPayment(paymentMethod);
      }

      function setupEventListeners() {
       
        document.querySelectorAll(".payment-method").forEach((pm) => {
          pm.addEventListener("click", function () {
            document.querySelectorAll(".payment-method").forEach((m) => m.classList.remove("selected"));
            this.classList.add("selected");
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            handlePaymentMethodChange();
          });
        });

        document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
          radio.addEventListener("change", updateOrderSummary);
        });

     
        document.getElementById('payButton')?.addEventListener('click', initiateRazorpayPayment);

       
        document.getElementById('refreshQR')?.addEventListener('click', generateQRCode);

    
        const hamburger = document.querySelector(".hamburger");
        const navMenu = document.querySelector("nav ul");
        if (hamburger) {
          hamburger.addEventListener("click", () => navMenu.classList.toggle("show"));
        }

        const checkoutForm = document.getElementById("checkoutForm");
        checkoutForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("üîÑ Form submitted - Starting order process");

          if (!validateForm()) {
            console.log("‚ùå Form validation failed");
            return;
          }

          const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
          if (!paymentMethod) {
            showErrorMessage("Please select a payment method");
            return;
          }

       
          if (paymentMethod === 'razorpay' || paymentMethod === 'qr') {
            if (paymentMethod === 'razorpay') {
              initiateRazorpayPayment();
            }
           
            return;
          }

          const submitBtn = document.getElementById("submitOrder");
          const submitText = document.getElementById("submitText");
          const spinner = document.querySelector(".loading-spinner");

          submitBtn.disabled = true;
          submitText.textContent = "Processing...";
          spinner.style.display = "inline-block";

          console.log("‚úÖ Form validated, calling createOrder for COD...");
          await createOrder(paymentMethod);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ Checkout page loaded");
        fetchCart();
        setupEventListeners();
        
  
        setTimeout(() => {
          handlePaymentMethodChange();
        }, 1500);
      });
    </script>
</body>
</html> -->







<!--

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - SaiKrupa Paithani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="nav.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#800000",
              primaryLight: "#b30000",
              gold: "#D4AF37",
              lightGold: "#F2E8C9",
              cream: "#F8F4E3",
              darkRed: "#680000",
              gray: "#777",
              lightGray: "#f5f5f5",
              white: "#ffffff",
              black: "#333333",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f4e3;
      }
      .checkout-step {
        transition: all 0.3s ease;
      }
      .checkout-step.active {
        border-color: #d4af37;
        background-color: #f8f4e3;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.95);
        color: #800000;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 15px rgba(128, 0, 0, 0.1);
        height: 80px;
      }
      nav ul {
        display: flex;
        list-style: none;
      }
      nav ul li {
        position: relative;
        margin: 0 15px;
      }
      nav ul li a {
        color: #800000;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        padding: 10px 5px;
        display: block;
        position: relative;
      }
      nav ul li a:after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #800000;
        left: 0;
        bottom: 0;
        transition: width 0.3s ease;
      }
      nav ul li a:hover:after {
        width: 100%;
      }
      .nav-icons {
        display: flex;
        align-items: center;
      }
      .nav-icon {
        color: #800000;
        font-size: 1.3rem;
        margin-left: 20px;
        position: relative;
        cursor: pointer;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #800000;
        color: white;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 20px;
        color: #800000;
      }
      .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .payment-method:hover {
        border-color: #d4af37;
      }
      .payment-method.selected {
        border-color: #800000;
        background-color: #f8f4e3;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 20px;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .step.active .step-number {
        background: #800000;
        color: white;
      }
      .step.completed .step-number {
        background: #d4af37;
        color: white;
      }
      .step-text {
        font-size: 0.9rem;
        color: #777;
      }
      .step.active .step-text {
        color: #800000;
        font-weight: 600;
      }
      .loading-spinner {
        display: none;
      }
      .loading-spinner.active {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }
      .qr-code-container {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 15px;
      }
      .qr-code {
        display: inline-block;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
      }
      .upi-instructions {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: left;
      }
      .upi-instructions ol {
        padding-left: 20px;
      }
      .upi-instructions li {
        margin-bottom: 8px;
        color: #555;
      }
      @media (max-width: 900px) {
        nav ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          background: rgba(255, 255, 255, 0.98);
          flex-direction: column;
          padding: 20px;
        }
        nav ul.show {
          display: flex;
        }
        nav ul li {
          margin: 10px 0;
          width: 100%;
          text-align: center;
        }
        .hamburger {
          display: block;
        }
      }
    </style>
</head>
<body class="bg-cream">
    <nav>
      <a href="dashboard.html" class="logo flex items-center font-bold text-darkRed">
        <img src="images/logo3.png" alt="Paithani Logo" class="logo-img h-20 w-20 rounded-full mr-3" />
        <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
      </a>
      <ul>
          <li><a href="dashboard.html">Home</a></li>
        <li><a href="product.html">Collections</a></li>
        <li><a href="#testimonials">Testimonials</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-icons">
        <a href="history.html"><div class="nav-icon"><i class="fas fa-shipping-fast mr-2"></i></div></a>
        <div class="nav-icon">
          <a href="cart.html"
            ><i class="fas fa-shopping-cart"></i
            ><span class="cart-count" id="headerCartCount">0</span></a
          >
        </div>
        <div class="hamburger">&#9776;</div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-4 text-gray">
      <a href="dashboard.html"
        ><span class="hover:text-primary cursor-pointer">Home</span> /
      </a>
      <a href="cart.html"
        ><span class="hover:text-primary cursor-pointer">Cart</span> /
      </a>
      <span class="text-primary">Checkout</span>
    </div>

    <div class="container mx-auto px-6 py-6">
      <div class="step-indicator">
        <div class="step completed">
          <div class="step-number"><i class="fas fa-check"></i></div>
          <div class="step-text">Cart</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-text">Information</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">Shipping</div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">Payment</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Checkout</h1>
      <p class="text-gray mb-8">Complete your purchase with secure checkout</p>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <form id="checkoutForm">
       
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step active">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">1</div>
                <h2 class="text-xl font-semibold text-primary">Contact Information</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
                <div>
                  <label for="phone" class="block text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="newsletter" class="mr-2" />
                <label for="newsletter" class="text-gray-700">Email me with news and offers</label>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">2</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Address</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="firstName" class="block text-gray-700 mb-2">First Name *</label><input type="text" id="firstName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="lastName" class="block text-gray-700 mb-2">Last Name *</label><input type="text" id="lastName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div class="md:col-span-2"><label for="address" class="block text-gray-700 mb-2">Address *</label><input type="text" id="address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="city" class="block text-gray-700 mb-2">City *</label><input type="text" id="city" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div>
                  <label for="state" class="block text-gray-700 mb-2">State *</label>
                  <select id="state" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <option value="">Select State</option>
                    <option value="MH">Maharashtra</option>
                    <option value="DL">Delhi</option>
                    <option value="KA">Karnataka</option>
                    <option value="TN">Tamil Nadu</option>
                    <option value="GJ">Gujarat</option>
                    <option value="UP">Uttar Pradesh</option>
                    <option value="WB">West Bengal</option>
                  </select>
                </div>
                <div><label for="pincode" class="block text-gray-700 mb-2">PIN Code *</label><input type="text" id="pincode" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="saveAddress" class="mr-2" />
                <label for="saveAddress" class="text-gray-700">Save this information for next time</label>
              </div>
            </div>

      
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">3</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Method</h2>
              </div>
              <div class="space-y-4">
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="standard" name="shipping" value="standard" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="standard" class="font-medium">Standard Shipping</label>
                      <p class="text-gray text-sm">5-7 business days ‚Ä¢ ‚Çπ200</p>
                    </div>
                    <span class="font-semibold">‚Çπ200</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="express" name="shipping" value="express" class="mr-3" />
                    <div class="flex-1">
                      <label for="express" class="font-medium">Express Shipping</label>
                      <p class="text-gray text-sm">2-3 business days ‚Ä¢ ‚Çπ500</p>
                    </div>
                    <span class="font-semibold">‚Çπ500</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="free" name="shipping" value="free" class="mr-3" />
                    <div class="flex-1">
                      <label for="free" class="font-medium">Free Shipping</label>
                      <p class="text-gray text-sm">7-10 business days ‚Ä¢ Free on orders above ‚Çπ10,000</p>
                    </div>
                    <span class="font-semibold text-green-600">FREE</span>
                  </div>
                </div>
              </div>
            </div>

           
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step" id="paymentSection">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">4</div>
                <h2 class="text-xl font-semibold text-primary">Payment Method</h2>
              </div>

              <div class="space-y-4">
               
                <div class="payment-method selected">
                  <div class="flex items-center">
                    <input type="radio" id="upiQR" name="payment" value="upiQR" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="upiQR" class="font-medium">UPI QR Code Payment</label>
                      <p class="text-gray text-sm">Scan QR code with any UPI app to pay instantly</p>
                    </div>
                  </div>
           
                  <div id="upiQRContainer" class="qr-code-container mt-4">
                    <h4 class="font-semibold text-primary mb-3">Scan to Pay with UPI</h4>
                    <div class="qr-code" id="qrcode"></div>
                    <div class="mt-3">
                      <p class="font-medium">UPI ID: <span class="text-primary">rahulbhandge@ybl</span></p>
                      <p class="text-sm text-gray">Amount: ‚Çπ<span id="qrAmount">0</span></p>
                    </div>
                    
                    <div class="upi-instructions mt-4">
                      <h5 class="font-semibold mb-2">How to Pay:</h5>
                      <ol class="text-sm">
                        <li>Open any UPI app on your phone (Google Pay, PhonePe, Paytm, etc.)</li>
                        <li>Tap on 'Scan QR Code'</li>
                        <li>Scan the QR code above</li>
                        <li>Verify the amount and UPI ID</li>
                        <li>Enter your UPI PIN to complete payment</li>
                        <li>Click 'Confirm Payment' below after successful payment</li>
                      </ol>
                    </div>
                  </div>
                </div>

                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="razorpay" name="payment" value="razorpay" class="mr-3" />
                    <div class="flex-1">
                      <label for="razorpay" class="font-medium">Credit/Debit Card</label>
                      <p class="text-gray text-sm">Pay securely using your card</p>
                    </div>
                  </div>
                </div>

                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment" value="cod" class="mr-3" />
                    <div class="flex-1">
                      <label for="cod" class="font-medium">Cash on Delivery</label>
                      <p class="text-gray text-sm">Pay when you receive your order (Additional ‚Çπ50 COD charges apply)</p>
                    </div>
                  </div>
                </div>
              </div>

   
              <div class="mt-6 p-4 bg-lightGold rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt text-primary text-xl mr-3"></i>
                  <div>
                    <h4 class="font-semibold text-primary">Your payment is 100% secure</h4>
                    <p class="text-sm text-gray">All transactions are encrypted and secure. We do not store your payment details.</p>
                  </div>
                </div>
              </div>

             
              <div id="paymentButtonContainer" class="mt-6">
                <button type="button" id="payButton" class="w-full bg-primary hover:bg-darkRed text-white py-4 px-6 rounded-lg font-semibold text-lg flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-qrcode mr-2"></i>
                  Confirm Payment - ‚Çπ<span id="payAmount">0</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2" id="paymentInstructions">
                  Scan the QR code above and click after successful payment
                </p>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <a href="cart.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Cart
              </a>
              <button type="submit" id="submitOrder" class="bg-primary hover:bg-darkRed text-white py-3 px-8 rounded-lg font-semibold text-lg flex items-center">
                <span id="submitText">Complete Order</span>
                <i class="fas fa-lock ml-2"></i>
                <i class="fas fa-spinner loading-spinner ml-2"></i>
              </button>
            </div>
          </form>
        </div>

    
        <div class="lg:w-1/3">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-primary mb-4">Order Summary</h2>
            <div class="mb-6 max-h-80 overflow-y-auto" id="orderItemsContainer"></div>
            <div class="space-y-3 mb-6" id="orderSummary">
              <div class="flex justify-between">
                <span class="text-gray">Subtotal (<span id="summaryItemCount">0</span> items)</span>
                <span class="font-medium" id="subtotalAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Shipping</span>
                <span class="font-medium" id="shippingAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Tax</span>
                <span class="font-medium" id="taxAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-green-600" id="discountSection" style="display: none">
                <span>Discount</span>
                <span id="discountAmount">-‚Çπ0</span>
              </div>
              <div class="flex justify-between text-orange-600" id="codChargesSection" style="display: none">
                <span>COD Charges</span>
                <span id="codChargesAmount">‚Çπ50</span>
              </div>
              <div class="border-t pt-3 flex justify-between text-lg font-bold">
                <span>Total</span>
                <span class="text-primary" id="totalAmount">‚Çπ0</span>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-center mb-3">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                <span class="text-sm font-medium">100% Secure Checkout</span>
              </div>
              <div class="flex justify-center space-x-4">
                <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                <i class="fab fa-google-pay text-2xl text-gray-500"></i>
                <i class="fab fa-amazon-pay text-2xl text-gray-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Need Help?</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <i class="fas fa-phone text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Call Us</p>
                  <p class="text-sm text-gray">+91 98765 43210</p>
                </div>
              </div>
              <div class="flex items-center">
                <i class="fas fa-comments text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Chat with Us</p>
                  <p class="text-sm text-gray">Available 24/7</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-primary text-white mt-12 py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">SaiKrupa Paithani</h3>
            <p class="text-lightGold">Bringing traditional Maharashtrian elegance to your doorstep with authentic handwoven Paithani sarees.</p>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">About Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Collections</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Shipping Policy</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Return Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">Contact Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">FAQs</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Track Order</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Newsletter</h4>
            <p class="text-lightGold mb-4">Subscribe to get special offers and once-in-a-lifetime deals.</p>
            <div class="flex">
              <input type="email" placeholder="Your email" class="px-4 py-2 rounded-l-lg w-full text-black" />
              <button class="bg-gold text-black px-4 py-2 rounded-r-lg font-semibold">Subscribe</button>
            </div>
          </div>
        </div>
        <div class="border-t border-primaryLight mt-8 pt-8 text-center">
          <p>¬© 2025 SaiKrupa Paithani. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script>
  
      let cartItems = [];
      let orderTotals = {
        subtotal: 0,
        shipping: 0,
        tax: 0,
        discount: 0,
        codCharges: 0,
        total: 0,
      };
      let razorpayOrderId = null;
      let isProcessingPayment = false;
      let qrCode = null;

   
      function getAuthToken() {
        return localStorage.getItem("authToken") || localStorage.getItem("token");
      }

      function checkAuth() {
        const token = getAuthToken();
        if (!token) {
          alert("Please login to proceed with checkout");
          window.location.href = "signup_login.html";
          return false;
        }
        return true;
      }

      function showSuccessMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

      function showErrorMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

     
      function generateUPIQrCode(amount) {
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = ''; 
        
     
        const upiLink = `upi://pay?pa=rahulbhandge@ybl&pn=SaiKrupa+Paithani&am=${amount}&cu=INR&tn=Order+Payment`;
    
        qrCode = new QRCode(qrContainer, {
          text: upiLink,
          width: 200,
          height: 200,
          colorDark: "#800000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
        
        
        document.getElementById('qrAmount').textContent = amount.toLocaleString();
      }

     
      async function sendOrderConfirmationEmail(orderData, orderId, orderNumber, paymentMethod) {
        try {
          const token = getAuthToken();
          const customerEmail = document.getElementById("email").value;
          
          const emailData = {
            to: customerEmail,
            subject: paymentMethod === 'cod' 
              ? `Order Confirmed - Your SaiKrupa Paithani Order #${orderNumber}`
              : `Payment Successful - Your SaiKrupa Paithani Order #${orderNumber}`,
            orderId: orderId,
            orderNumber: orderNumber,
            customerName: `${document.getElementById("firstName").value} ${document.getElementById("lastName").value}`,
            orderData: orderData,
            paymentMethod: paymentMethod,
            totalAmount: orderTotals.total
          };

          console.log("üìß Sending email notification:", emailData);

          const response = await fetch('http://localhost:5000/api/email/send-order-confirmation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(emailData)
          });

          const result = await response.json();
          
          if (result.success) {
            console.log("‚úÖ Email sent successfully");
          } else {
            console.warn("‚ö†Ô∏è Email sending failed:", result.message);
          }
        } catch (error) {
          console.error("‚ùå Email sending error:", error);
        }
      }

  
      async function fetchCart() {
        if (!checkAuth()) return;

        try {
          const token = getAuthToken();
          console.log("üîÑ Fetching cart data...");

          const res = await fetch("http://localhost:5000/api/cart", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem("authToken");
              localStorage.removeItem("token");
              window.location.href = "signup_login.html";
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const result = await res.json();
          console.log("üì¶ Cart API response:", result);

          if (result.success && result.cart) {
            cartItems = result.cart.items.map((item) => {
              const product = item.productId;
              return {
                productId: product._id,
                name: product.name || "Product",
                image: product.images?.[0] || "images/default.jpg",
                price: item.price || product.price || 0,
                quantity: item.quantity || 1,
              };
            });

            console.log("üõí Processed cart items:", cartItems);

            if (cartItems.length === 0) {
              showErrorMessage("Your cart is empty");
              setTimeout(() => {
                window.location.href = "cart.html";
              }, 2000);
              return;
            }

            renderOrderItems();
            updateOrderSummary();
            updateCartCount();
          } else {
            throw new Error(result.message || "Failed to fetch cart");
          }
        } catch (err) {
          console.error("‚ùå Fetch cart error:", err);
          showErrorMessage("Failed to load cart items: " + err.message);
        }
      }

      function renderOrderItems() {
        const container = document.getElementById("orderItemsContainer");
        container.innerHTML = cartItems.map((item) => {
          const itemTotal = item.price * item.quantity;
          return `
            <div class="flex border-b border-gray-200 py-4">
              <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex items-center justify-center">
                <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-primary">${item.name}</h3>
                <p class="text-gray text-sm">Qty: ${item.quantity}</p>
                <p class="text-primary font-semibold">‚Çπ${itemTotal.toLocaleString()}</p>
              </div>
            </div>
          `;
        }).join("");
      }

      function updateOrderSummary() {
        const subtotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

        const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
        let shipping = 0;
        if (shippingMethod === "express") shipping = 500;
        else if (shippingMethod === "standard") shipping = 200;
        else if (shippingMethod === "free") shipping = subtotal > 10000 ? 0 : 200;

        const tax = Math.round(subtotal * 0.02);
        const discount = subtotal > 5000 ? Math.round(subtotal * 0.1) : 0;
        
  
        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
        const codCharges = paymentMethod === 'cod' ? 50 : 0;
        
        const total = subtotal + shipping + tax - discount + codCharges;

        orderTotals = { subtotal, shipping, tax, discount, codCharges, total };

        document.getElementById("summaryItemCount").textContent = itemCount;
        document.getElementById("subtotalAmount").textContent = `‚Çπ${subtotal.toLocaleString()}`;
        document.getElementById("shippingAmount").textContent = shipping === 0 ? "FREE" : `‚Çπ${shipping}`;
        document.getElementById("taxAmount").textContent = `‚Çπ${tax.toLocaleString()}`;
        document.getElementById("totalAmount").textContent = `‚Çπ${total.toLocaleString()}`;

        const discountSection = document.getElementById("discountSection");
        const discountAmount = document.getElementById("discountAmount");
        if (discount > 0) {
          discountSection.style.display = "flex";
          discountAmount.textContent = `-‚Çπ${discount.toLocaleString()}`;
        } else {
          discountSection.style.display = "none";
        }

        
        const codSection = document.getElementById("codChargesSection");
        if (codCharges > 0) {
          codSection.style.display = "flex";
        } else {
          codSection.style.display = "none";
        }

       
        if (document.getElementById('payAmount')) {
          document.getElementById('payAmount').textContent = total.toLocaleString();
        }

     
        generateUPIQrCode(total);
      }

      function updateCartCount() {
        const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("headerCartCount").textContent = totalItems;
      }

      function getShippingAddress() {
        return {
          firstName: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          email: document.getElementById("email").value,
          phone: document.getElementById("phone").value,
          address: document.getElementById("address").value,
          city: document.getElementById("city").value,
          state: document.getElementById("state").value,
          pincode: document.getElementById("pincode").value,
        };
      }

      function validateForm() {
        const requiredFields = [
          "email", "phone", "firstName", "lastName", "address", "city", "state", "pincode",
        ];
        for (let field of requiredFields) {
          const el = document.getElementById(field);
          if (!el.value.trim()) {
            showErrorMessage(`Please fill in the ${field}`);
            el.focus();
            return false;
          }
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(document.getElementById("email").value)) {
          showErrorMessage("Invalid email");
          return false;
        }

        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(document.getElementById("phone").value.replace(/\D/g, ""))) {
          showErrorMessage("Invalid 10-digit phone number");
          return false;
        }

        return true;
      }

   
      function handlePaymentMethodChange() {
        const selectedMethod = document.querySelector('input[name="payment"]:checked').value;
        const payButton = document.getElementById('payButton');
        const paymentInstructions = document.getElementById('paymentInstructions');
        
 
        if (selectedMethod === 'cod') {
          payButton.innerHTML = '<i class="fas fa-box mr-2"></i> Place COD Order - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          paymentInstructions.textContent = 'Pay when you receive your order';
        } else if (selectedMethod === 'upiQR') {
          payButton.innerHTML = '<i class="fas fa-qrcode mr-2"></i> Confirm Payment - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          paymentInstructions.textContent = 'Scan the QR code above and click after successful payment';
        } else {
          payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          paymentInstructions.textContent = 'You will be redirected to secure payment page';
        }
        
        updateOrderSummary();
      }

      async function initiateRazorpayPayment() {
        if (isProcessingPayment) return;
        
        try {
          isProcessingPayment = true;
          const payButton = document.getElementById('payButton');
          const originalText = payButton.innerHTML;
          
          payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
          payButton.disabled = true;

          const token = getAuthToken();
          const response = await fetch('http://localhost:5000/api/payments/create-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              amount: orderTotals.total,
              currency: 'INR',
              receipt: `receipt_${Date.now()}`
            })
          });

          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.message);
          }

          const options = {
            key: 'rzp_test_Rg2ZENKibKx5N2',
            amount: result.order.amount,
            currency: result.order.currency,
            name: "SaiKrupa Paithani",
            description: "Purchase of Paithani Products",
            order_id: result.order.id,
            handler: async function(response) {
              await handlePaymentSuccess(response);
            },
            prefill: {
              name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
              email: document.getElementById('email').value,
              contact: document.getElementById('phone').value
            },
            notes: {
              address: "SaiKrupa Paithani Store"
            },
            theme: {
              color: "#800000"
            },
            method: {
              netbanking: true,
              card: true,
              upi: true,
              wallet: true,
              qr_code: false,
            },
            modal: {
              ondismiss: function() {
                isProcessingPayment = false;
                payButton.innerHTML = originalText;
                payButton.disabled = false;
                console.log("Payment modal closed");
              }
            }
          };

          const rzp = new Razorpay(options);
          rzp.open();
          
        } catch (error) {
          console.error("‚ùå Payment initiation error:", error);
          showErrorMessage("Failed to initiate payment: " + error.message);
          isProcessingPayment = false;
          
          const payButton = document.getElementById('payButton');
          payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          payButton.disabled = false;
        }
      }

      async function handlePaymentSuccess(paymentResponse) {
        try {
          console.log("‚úÖ Payment successful:", paymentResponse);
          
          const token = getAuthToken();
          
          const verifyResponse = await fetch('http://localhost:5000/api/payments/verify-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              razorpay_order_id: paymentResponse.razorpay_order_id,
              razorpay_payment_id: paymentResponse.razorpay_payment_id,
              razorpay_signature: paymentResponse.razorpay_signature
            })
          });

          if (!verifyResponse.ok) {
            if (verifyResponse.status === 404) {
              console.warn("‚ö†Ô∏è Payment verification endpoint not found, proceeding with order creation...");
              await createOrderWithPayment('razorpay', paymentResponse);
              return;
            }
            throw new Error(`HTTP error! status: ${verifyResponse.status}`);
          }

          const result = await verifyResponse.json();
          
          if (result.success) {
            showSuccessMessage("Payment verified successfully! Creating your order...");
            await createOrderWithPayment('razorpay', paymentResponse);
          } else {
            throw new Error("Payment verification failed");
          }
        } catch (error) {
          console.error("‚ùå Payment verification error:", error);
          if (error.message.includes('404') || error.message.includes('JSON')) {
            showErrorMessage("Payment verification service unavailable. Creating order anyway...");
            await createOrderWithPayment('razorpay', paymentResponse);
          } else {
            showErrorMessage("Payment verification failed: " + error.message);
          }
        } finally {
          isProcessingPayment = false;
        }
      }

      async function createOrderWithPayment(paymentMethod, paymentResponse = null) {
        const submitBtn = document.getElementById("submitOrder");
        const submitText = document.getElementById("submitText");
        const spinner = document.querySelector(".loading-spinner");

        try {
          console.log("=== STARTING ORDER CREATION WITH PAYMENT ===");

          const token = getAuthToken();
          if (!token) {
            showErrorMessage("Please login first");
            return;
          }

          if (!cartItems || cartItems.length === 0) {
            showErrorMessage("Your cart is empty");
            return;
          }

          const shippingAddress = getShippingAddress();
          const orderData = {
            shippingAddress: shippingAddress,
            paymentMethod: paymentMethod,
            shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
            items: cartItems,
            paymentResponse: paymentResponse
          };

          console.log("üì¶ Final Order Data:", orderData);

          const response = await fetch("http://localhost:5000/api/orders/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });

          const responseText = await response.text();
          console.log("üì® Raw Response:", responseText);

          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error("‚ùå JSON Parse Error:", parseError);
            throw new Error("Server returned invalid JSON: " + responseText);
          }

          if (result.success) {
            console.log("‚úÖ ORDER CREATED SUCCESSFULLY! Order ID:", result.order._id);
            showSuccessMessage("Order placed successfully!");

            await sendOrderConfirmationEmail(
              orderData, 
              result.order._id, 
              result.order.orderNumber, 
              paymentMethod
            );

            setTimeout(() => {
              window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
            }, 2000);
          } else {
            throw new Error(result.message || "Failed to create order");
          }
        } catch (err) {
          console.error("üí• FINAL ERROR:", err);
          showErrorMessage("Failed to place order: " + err.message);
        } finally {
          submitBtn.disabled = false;
          submitText.textContent = "Complete Order";
          spinner.style.display = "none";
        }
      }

      async function createOrder(paymentMethod) {
        await createOrderWithPayment(paymentMethod);
      }

      function setupEventListeners() {
      
        document.querySelectorAll(".payment-method").forEach((pm) => {
          pm.addEventListener("click", function () {
            document.querySelectorAll(".payment-method").forEach((m) => m.classList.remove("selected"));
            this.classList.add("selected");
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            handlePaymentMethodChange();
          });
        });

        
        document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
          radio.addEventListener("change", updateOrderSummary);
        });

    
        document.getElementById('payButton')?.addEventListener('click', function() {
          const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
          
          if (paymentMethod === 'cod') {
           
            document.getElementById('checkoutForm').dispatchEvent(new Event('submit'));
          } else if (paymentMethod === 'upiQR') {
           
            const confirmed = confirm(`Have you successfully completed the UPI payment of ‚Çπ${orderTotals.total.toLocaleString()}?\n\nPlease ensure you have:\n1. Scanned the QR code\n2. Completed payment in your UPI app\n3. Received payment confirmation`);
            
            if (confirmed) {
              const submitBtn = document.getElementById("submitOrder");
              const submitText = document.getElementById("submitText");
              const spinner = document.querySelector(".loading-spinner");

              submitBtn.disabled = true;
              submitText.textContent = "Processing...";
              spinner.style.display = "inline-block";

              console.log("‚úÖ Creating UPI QR order...");
              createOrder('upiQR');
            }
          } else {
           
            initiateRazorpayPayment();
          }
        });

      
        const hamburger = document.querySelector(".hamburger");
        const navMenu = document.querySelector("nav ul");
        if (hamburger) {
          hamburger.addEventListener("click", () => navMenu.classList.toggle("show"));
        }

   
        const checkoutForm = document.getElementById("checkoutForm");
        checkoutForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("üîÑ Form submitted");

          if (!validateForm()) {
            console.log("‚ùå Form validation failed");
            return;
          }

          const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
          if (!paymentMethod) {
            showErrorMessage("Please select a payment method");
            return;
          }

          const submitBtn = document.getElementById("submitOrder");
          const submitText = document.getElementById("submitText");
          const spinner = document.querySelector(".loading-spinner");

          submitBtn.disabled = true;
          submitText.textContent = "Processing...";
          spinner.style.display = "inline-block";

     
          if (paymentMethod === 'razorpay') {
            initiateRazorpayPayment();
            submitBtn.disabled = false;
            submitText.textContent = "Complete Order";
            spinner.style.display = "none";
            return;
          }

        
          console.log("‚úÖ Creating COD order...");
          await createOrder(paymentMethod);
        });
      }

   
      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ Checkout page loaded");
        fetchCart();
        setupEventListeners();
        
        
        setTimeout(() => {
          handlePaymentMethodChange();
        }, 1500);
      });
    </script>
</body>
</html> -->











<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - SaiKrupa Paithani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="nav.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#800000",
              primaryLight: "#b30000",
              gold: "#D4AF37",
              lightGold: "#F2E8C9",
              cream: "#F8F4E3",
              darkRed: "#680000",
              gray: "#777",
              lightGray: "#f5f5f5",
              white: "#ffffff",
              black: "#333333",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f4e3;
      }
      .checkout-step {
        transition: all 0.3s ease;
      }
      .checkout-step.active {
        border-color: #d4af37;
        background-color: #f8f4e3;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.95);
        color: #800000;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 15px rgba(128, 0, 0, 0.1);
        height: 80px;
      }
      nav ul {
        display: flex;
        list-style: none;
      }
      nav ul li {
        position: relative;
        margin: 0 15px;
      }
      nav ul li a {
        color: #800000;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        padding: 10px 5px;
        display: block;
        position: relative;
      }
      nav ul li a:after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #800000;
        left: 0;
        bottom: 0;
        transition: width 0.3s ease;
      }
      nav ul li a:hover:after {
        width: 100%;
      }
      .nav-icons {
        display: flex;
        align-items: center;
      }
      .nav-icon {
        color: #800000;
        font-size: 1.3rem;
        margin-left: 20px;
        position: relative;
        cursor: pointer;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #800000;
        color: white;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 20px;
        color: #800000;
      }
      .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .payment-method:hover {
        border-color: #d4af37;
      }
      .payment-method.selected {
        border-color: #800000;
        background-color: #f8f4e3;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 20px;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .step.active .step-number {
        background: #800000;
        color: white;
      }
      .step.completed .step-number {
        background: #d4af37;
        color: white;
      }
      .step-text {
        font-size: 0.9rem;
        color: #777;
      }
      .step.active .step-text {
        color: #800000;
        font-weight: 600;
      }
      .loading-spinner {
        display: none;
      }
      .loading-spinner.active {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }
      .qr-code-container {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 15px;
      }
      .qr-code {
        display: inline-block;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
      }
      .upi-instructions {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: left;
      }
      .upi-instructions ol {
        padding-left: 20px;
      }
      .upi-instructions li {
        margin-bottom: 8px;
        color: #555;
      }
      .payment-success-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .payment-success-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      @media (max-width: 900px) {
        nav ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          background: rgba(255, 255, 255, 0.98);
          flex-direction: column;
          padding: 20px;
        }
        nav ul.show {
          display: flex;
        }
        nav ul li {
          margin: 10px 0;
          width: 100%;
          text-align: center;
        }
        .hamburger {
          display: block;
        }
      }
    </style>
</head>
<body class="bg-cream">
    <nav>
      <a href="dashboard.html" class="logo flex items-center font-bold text-darkRed">
        <img src="images/logo3.png" alt="Paithani Logo" class="logo-img h-20 w-20 rounded-full mr-3" />
        <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
      </a>
      <ul>
          <li><a href="dashboard.html">Home</a></li>
        <li><a href="product.html">Collections</a></li>
        <li><a href="#testimonials">Testimonials</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-icons">
        <a href="history.html"><div class="nav-icon"><i class="fas fa-shipping-fast mr-2"></i></div></a>
        <div class="nav-icon">
          <a href="cart.html"
            ><i class="fas fa-shopping-cart"></i
            ><span class="cart-count" id="headerCartCount">0</span></a
          >
        </div>
        <div class="hamburger">&#9776;</div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-4 text-gray">
      <a href="dashboard.html"
        ><span class="hover:text-primary cursor-pointer">Home</span> /
      </a>
      <a href="cart.html"
        ><span class="hover:text-primary cursor-pointer">Cart</span> /
      </a>
      <span class="text-primary">Checkout</span>
    </div>

    <div class="container mx-auto px-6 py-6">
      <div class="step-indicator">
        <div class="step completed">
          <div class="step-number"><i class="fas fa-check"></i></div>
          <div class="step-text">Cart</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-text">Information</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">Shipping</div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">Payment</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Checkout</h1>
      <p class="text-gray mb-8">Complete your purchase with secure checkout</p>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <form id="checkoutForm">
          
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step active">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">1</div>
                <h2 class="text-xl font-semibold text-primary">Contact Information</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
                <div>
                  <label for="phone" class="block text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="newsletter" class="mr-2" />
                <label for="newsletter" class="text-gray-700">Email me with news and offers</label>
              </div>
            </div>

         
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">2</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Address</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="firstName" class="block text-gray-700 mb-2">First Name *</label><input type="text" id="firstName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="lastName" class="block text-gray-700 mb-2">Last Name *</label><input type="text" id="lastName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div class="md:col-span-2"><label for="address" class="block text-gray-700 mb-2">Address *</label><input type="text" id="address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="city" class="block text-gray-700 mb-2">City *</label><input type="text" id="city" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div>
                  <label for="state" class="block text-gray-700 mb-2">State *</label>
                  <select id="state" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <option value="">Select State</option>
                    <option value="MH">Maharashtra</option>
                    <option value="DL">Delhi</option>
                    <option value="KA">Karnataka</option>
                    <option value="TN">Tamil Nadu</option>
                    <option value="GJ">Gujarat</option>
                    <option value="UP">Uttar Pradesh</option>
                    <option value="WB">West Bengal</option>
                  </select>
                </div>
                <div><label for="pincode" class="block text-gray-700 mb-2">PIN Code *</label><input type="text" id="pincode" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="saveAddress" class="mr-2" />
                <label for="saveAddress" class="text-gray-700">Save this information for next time</label>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">3</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Method</h2>
              </div>
              <div class="space-y-4">
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="standard" name="shipping" value="standard" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="standard" class="font-medium">Standard Shipping</label>
                      <p class="text-gray text-sm">5-7 business days ‚Ä¢ ‚Çπ200</p>
                    </div>
                    <span class="font-semibold">‚Çπ200</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="express" name="shipping" value="express" class="mr-3" />
                    <div class="flex-1">
                      <label for="express" class="font-medium">Express Shipping</label>
                      <p class="text-gray text-sm">2-3 business days ‚Ä¢ ‚Çπ500</p>
                    </div>
                    <span class="font-semibold">‚Çπ500</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="free" name="shipping" value="free" class="mr-3" />
                    <div class="flex-1">
                      <label for="free" class="font-medium">Free Shipping</label>
                      <p class="text-gray text-sm">7-10 business days ‚Ä¢ Free on orders above ‚Çπ10,000</p>
                    </div>
                    <span class="font-semibold text-green-600">FREE</span>
                  </div>
                </div>
              </div>
            </div>

          
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step" id="paymentSection">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">4</div>
                <h2 class="text-xl font-semibold text-primary">Payment Method</h2>
              </div>

              <div class="space-y-4">
                
                <div class="payment-method selected">
                  <div class="flex items-center">
                    <input type="radio" id="upiQR" name="payment" value="qr" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="upiQR" class="font-medium">UPI QR Code Payment</label>
                      <p class="text-gray text-sm">Scan QR code with any UPI app to pay instantly</p>
                    </div>
                  </div>
                  
                 
                  <div id="upiQRContainer" class="qr-code-container mt-4 hidden">
                    <h4 class="font-semibold text-primary mb-3">Scan to Pay with UPI</h4>
                    <div class="qr-code" id="qrcode"></div>
                    <div class="mt-3">
                      <p class="font-medium">UPI ID: <span class="text-primary">rahulbhandge@ybl</span></p>
                      <p class="text-sm text-gray">Amount: ‚Çπ<span id="qrAmount">0</span></p>
                    </div>
                    
                    <div class="upi-instructions mt-4">
                      <h5 class="font-semibold mb-2">How to Pay:</h5>
                      <ol class="text-sm">
                        <li>Open any UPI app on your phone (Google Pay, PhonePe, Paytm, etc.)</li>
                        <li>Tap on 'Scan QR Code'</li>
                        <li>Scan the QR code above</li>
                        <li>Verify the amount and UPI ID</li>
                        <li>Enter your UPI PIN to complete payment</li>
                        <li>Click 'Confirm Payment' below after successful payment</li>
                      </ol>
                    </div>
                  </div>
                </div>

             
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="razorpay" name="payment" value="razorpay" class="mr-3" />
                    <div class="flex-1">
                      <label for="razorpay" class="font-medium">Credit/Debit Card</label>
                      <p class="text-gray text-sm">Pay securely using your card</p>
                    </div>
                  </div>
                </div>

                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment" value="cod" class="mr-3" />
                    <div class="flex-1">
                      <label for="cod" class="font-medium">Cash on Delivery</label>
                      <p class="text-gray text-sm">Pay when you receive your order (Additional ‚Çπ50 COD charges apply)</p>
                    </div>
                  </div>
                </div>
              </div>

          
              <div class="mt-6 p-4 bg-lightGold rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt text-primary text-xl mr-3"></i>
                  <div>
                    <h4 class="font-semibold text-primary">Your payment is 100% secure</h4>
                    <p class="text-sm text-gray">All transactions are encrypted and secure. We do not store your payment details.</p>
                  </div>
                </div>
              </div>

              
              <div id="paymentButtonContainer" class="mt-6">
                <button type="button" id="payButton" class="w-full bg-primary hover:bg-darkRed text-white py-4 px-6 rounded-lg font-semibold text-lg flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-qrcode mr-2"></i>
                  Confirm Payment - ‚Çπ<span id="payAmount">0</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2" id="paymentInstructions">
                  Select payment method and click to proceed
                </p>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <a href="cart.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Cart
              </a>
              <button type="submit" id="submitOrder" class="bg-primary hover:bg-darkRed text-white py-3 px-8 rounded-lg font-semibold text-lg flex items-center">
                <span id="submitText">Complete Order</span>
                <i class="fas fa-lock ml-2"></i>
                <i class="fas fa-spinner loading-spinner ml-2"></i>
              </button>
            </div>
          </form>
        </div>

  
        <div class="lg:w-1/3">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-primary mb-4">Order Summary</h2>
            <div class="mb-6 max-h-80 overflow-y-auto" id="orderItemsContainer"></div>
            <div class="space-y-3 mb-6" id="orderSummary">
              <div class="flex justify-between">
                <span class="text-gray">Subtotal (<span id="summaryItemCount">0</span> items)</span>
                <span class="font-medium" id="subtotalAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Shipping</span>
                <span class="font-medium" id="shippingAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Tax</span>
                <span class="font-medium" id="taxAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-green-600" id="discountSection" style="display: none">
                <span>Discount</span>
                <span id="discountAmount">-‚Çπ0</span>
              </div>
              <div class="flex justify-between text-orange-600" id="codChargesSection" style="display: none">
                <span>COD Charges</span>
                <span id="codChargesAmount">‚Çπ50</span>
              </div>
              <div class="border-t pt-3 flex justify-between text-lg font-bold">
                <span>Total</span>
                <span class="text-primary" id="totalAmount">‚Çπ0</span>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-center mb-3">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                <span class="text-sm font-medium">100% Secure Checkout</span>
              </div>
              <div class="flex justify-center space-x-4">
                <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                <i class="fab fa-google-pay text-2xl text-gray-500"></i>
                <i class="fab fa-amazon-pay text-2xl text-gray-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Need Help?</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <i class="fas fa-phone text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Call Us</p>
                  <p class="text-sm text-gray">+91 98765 43210</p>
                </div>
              </div>
              <div class="flex items-center">
                <i class="fas fa-comments text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Chat with Us</p>
                  <p class="text-sm text-gray">Available 24/7</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-primary text-white mt-12 py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">SaiKrupa Paithani</h3>
            <p class="text-lightGold">Bringing traditional Maharashtrian elegance to your doorstep with authentic handwoven Paithani sarees.</p>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">About Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Collections</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Shipping Policy</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Return Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">Contact Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">FAQs</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Track Order</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Newsletter</h4>
            <p class="text-lightGold mb-4">Subscribe to get special offers and once-in-a-lifetime deals.</p>
            <div class="flex">
              <input type="email" placeholder="Your email" class="px-4 py-2 rounded-l-lg w-full text-black" />
              <button class="bg-gold text-black px-4 py-2 rounded-r-lg font-semibold">Subscribe</button>
            </div>
          </div>
        </div>
        <div class="border-t border-primaryLight mt-8 pt-8 text-center">
          <p>¬© 2025 SaiKrupa Paithani. All rights reserved.</p>
        </div>
      </div>
    </footer>


    <div id="paymentSuccessModal" class="payment-success-modal hidden">
      <div class="payment-success-content">
        <div class="text-green-500 text-6xl mb-4">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful!</h3>
        <p class="text-gray-600 mb-6">Your payment has been processed successfully. Redirecting to order confirmation...</p>
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
      </div>
    </div>

    <script>
     
      let cartItems = [];
      let orderTotals = {
        subtotal: 0,
        shipping: 0,
        tax: 0,
        discount: 0,
        codCharges: 0,
        total: 0,
      };
      let razorpayOrderId = null;
      let isProcessingPayment = false;
      let qrCode = null;

  
      function getAuthToken() {
        return localStorage.getItem("authToken") || localStorage.getItem("token");
      }

      function checkAuth() {
        const token = getAuthToken();
        if (!token) {
          alert("Please login to proceed with checkout");
          window.location.href = "signup_login.html";
          return false;
        }
        return true;
      }

      function showSuccessMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

      function showErrorMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }


      function generateUPIQrCode(amount) {
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = ''; 
        
    
        const upiLink = `upi://pay?pa=rahulbhandge@ybl&pn=SaiKrupa+Paithani&am=${amount}&cu=INR&tn=Order+Payment`;
    
        qrCode = new QRCode(qrContainer, {
          text: upiLink,
          width: 200,
          height: 200,
          colorDark: "#800000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
        
    
        document.getElementById('qrAmount').textContent = amount.toLocaleString();
        
   
        document.getElementById('upiQRContainer').classList.remove('hidden');
      }

     
      async function sendOrderConfirmationEmail(orderData, orderId, orderNumber, paymentMethod) {
        try {
          const token = getAuthToken();
          const customerEmail = document.getElementById("email").value;
          
          const emailData = {
            to: customerEmail,
            subject: paymentMethod === 'cod' 
              ? `Order Confirmed - Your SaiKrupa Paithani Order #${orderNumber}`
              : `Payment Successful - Your SaiKrupa Paithani Order #${orderNumber}`,
            orderId: orderId,
            orderNumber: orderNumber,
            customerName: `${document.getElementById("firstName").value} ${document.getElementById("lastName").value}`,
            orderData: orderData,
            paymentMethod: paymentMethod,
            totalAmount: orderTotals.total
          };

          console.log("üìß Sending email notification:", emailData);

          const response = await fetch('http://localhost:5000/api/email/send-order-confirmation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(emailData)
          });

          const result = await response.json();
          
          if (result.success) {
            console.log("‚úÖ Email sent successfully");
          } else {
            console.warn("‚ö†Ô∏è Email sending failed:", result.message);
          }
        } catch (error) {
          console.error("‚ùå Email sending error:", error);
        }
      }


      async function fetchCart() {
        if (!checkAuth()) return;

        try {
          const token = getAuthToken();
          console.log("üîÑ Fetching cart data...");

          const res = await fetch("http://localhost:5000/api/cart", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem("authToken");
              localStorage.removeItem("token");
              window.location.href = "signup_login.html";
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const result = await res.json();
          console.log("üì¶ Cart API response:", result);

          if (result.success && result.cart) {
            cartItems = result.cart.items.map((item) => {
              const product = item.productId;
              return {
                productId: product._id,
                name: product.name || "Product",
                image: product.images?.[0] || "images/default.jpg",
                price: item.price || product.price || 0,
                quantity: item.quantity || 1,
              };
            });

            console.log("üõí Processed cart items:", cartItems);

            if (cartItems.length === 0) {
              showErrorMessage("Your cart is empty");
              setTimeout(() => {
                window.location.href = "cart.html";
              }, 2000);
              return;
            }

            renderOrderItems();
            updateOrderSummary();
            updateCartCount();
          } else {
            throw new Error(result.message || "Failed to fetch cart");
          }
        } catch (err) {
          console.error("‚ùå Fetch cart error:", err);
          showErrorMessage("Failed to load cart items: " + err.message);
        }
      }

      function renderOrderItems() {
        const container = document.getElementById("orderItemsContainer");
        container.innerHTML = cartItems.map((item) => {
          const itemTotal = item.price * item.quantity;
          return `
            <div class="flex border-b border-gray-200 py-4">
              <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex items-center justify-center">
                <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-primary">${item.name}</h3>
                <p class="text-gray text-sm">Qty: ${item.quantity}</p>
                <p class="text-primary font-semibold">‚Çπ${itemTotal.toLocaleString()}</p>
              </div>
            </div>
          `;
        }).join("");
      }

      function updateOrderSummary() {
        const subtotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

        const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
        let shipping = 0;
        if (shippingMethod === "express") shipping = 500;
        else if (shippingMethod === "standard") shipping = 200;
        else if (shippingMethod === "free") shipping = subtotal > 10000 ? 0 : 200;

        const tax = Math.round(subtotal * 0.02);
        const discount = subtotal > 5000 ? Math.round(subtotal * 0.1) : 0;
        
    
        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
        const codCharges = paymentMethod === 'cod' ? 50 : 0;
        
        const total = subtotal + shipping + tax - discount + codCharges;

        orderTotals = { subtotal, shipping, tax, discount, codCharges, total };

        document.getElementById("summaryItemCount").textContent = itemCount;
        document.getElementById("subtotalAmount").textContent = `‚Çπ${subtotal.toLocaleString()}`;
        document.getElementById("shippingAmount").textContent = shipping === 0 ? "FREE" : `‚Çπ${shipping}`;
        document.getElementById("taxAmount").textContent = `‚Çπ${tax.toLocaleString()}`;
        document.getElementById("totalAmount").textContent = `‚Çπ${total.toLocaleString()}`;


        const discountSection = document.getElementById("discountSection");
        const discountAmount = document.getElementById("discountAmount");
        if (discount > 0) {
          discountSection.style.display = "flex";
          discountAmount.textContent = `-‚Çπ${discount.toLocaleString()}`;
        } else {
          discountSection.style.display = "none";
        }

        const codSection = document.getElementById("codChargesSection");
        if (codCharges > 0) {
          codSection.style.display = "flex";
        } else {
          codSection.style.display = "none";
        }

      
        if (document.getElementById('payAmount')) {
          document.getElementById('payAmount').textContent = total.toLocaleString();
        }
      }

      function updateCartCount() {
        const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("headerCartCount").textContent = totalItems;
      }

      function getShippingAddress() {
        return {
          firstName: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          email: document.getElementById("email").value,
          phone: document.getElementById("phone").value,
          address: document.getElementById("address").value,
          city: document.getElementById("city").value,
          state: document.getElementById("state").value,
          pincode: document.getElementById("pincode").value,
        };
      }

      function validateForm() {
        const requiredFields = [
          "email", "phone", "firstName", "lastName", "address", "city", "state", "pincode",
        ];
        for (let field of requiredFields) {
          const el = document.getElementById(field);
          if (!el.value.trim()) {
            showErrorMessage(`Please fill in the ${field}`);
            el.focus();
            return false;
          }
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(document.getElementById("email").value)) {
          showErrorMessage("Invalid email");
          return false;
        }

        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(document.getElementById("phone").value.replace(/\D/g, ""))) {
          showErrorMessage("Invalid 10-digit phone number");
          return false;
        }

        return true;
      }

      function handlePaymentMethodChange() {
        const selectedMethod = document.querySelector('input[name="payment"]:checked').value;
        const payButton = document.getElementById('payButton');
        const paymentInstructions = document.getElementById('paymentInstructions');
        

        document.getElementById('upiQRContainer').classList.add('hidden');
        
     
        if (selectedMethod === 'cod') {
          payButton.innerHTML = '<i class="fas fa-box mr-2"></i> Place COD Order - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          paymentInstructions.textContent = 'Pay when you receive your order';
        } else if (selectedMethod === 'qr') {
          payButton.innerHTML = '<i class="fas fa-qrcode mr-2"></i> Show QR Code - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          paymentInstructions.textContent = 'Click to generate QR code for payment';
        } else {
          payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          paymentInstructions.textContent = 'You will be redirected to secure payment page';
        }
        
        updateOrderSummary();
      }

      async function initiateRazorpayPayment() {
        if (isProcessingPayment) return;
        
        try {
          isProcessingPayment = true;
          const payButton = document.getElementById('payButton');
          const originalText = payButton.innerHTML;
          
          payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
          payButton.disabled = true;

          const token = getAuthToken();
          const response = await fetch('http://localhost:5000/api/payments/create-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              amount: orderTotals.total,
              currency: 'INR',
              receipt: `receipt_${Date.now()}`
            })
          });

          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.message);
          }

          const options = {
            key: 'rzp_test_Rg2ZENKibKx5N2',
            amount: result.order.amount,
            currency: result.order.currency,
            name: "SaiKrupa Paithani",
            description: "Purchase of Paithani Products",
            order_id: result.order.id,
            handler: async function(response) {
              await handlePaymentSuccess(response);
            },
            prefill: {
              name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
              email: document.getElementById('email').value,
              contact: document.getElementById('phone').value
            },
            notes: {
              address: "SaiKrupa Paithani Store"
            },
            theme: {
              color: "#800000"
            },
            method: {
              netbanking: true,
              card: true,
              upi: true,
              wallet: true,
              qr_code: false,
            },
            modal: {
              ondismiss: function() {
                isProcessingPayment = false;
                payButton.innerHTML = originalText;
                payButton.disabled = false;
                console.log("Payment modal closed");
              }
            }
          };

          const rzp = new Razorpay(options);
          rzp.open();
          
        } catch (error) {
          console.error("‚ùå Payment initiation error:", error);
          showErrorMessage("Failed to initiate payment: " + error.message);
          isProcessingPayment = false;
          
          const payButton = document.getElementById('payButton');
          payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          payButton.disabled = false;
        }
      }

      async function handlePaymentSuccess(paymentResponse) {
        try {
          console.log("‚úÖ Payment successful:", paymentResponse);
          
          const token = getAuthToken();
          
          const verifyResponse = await fetch('http://localhost:5000/api/payments/verify-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              razorpay_order_id: paymentResponse.razorpay_order_id,
              razorpay_payment_id: paymentResponse.razorpay_payment_id,
              razorpay_signature: paymentResponse.razorpay_signature
            })
          });

          if (!verifyResponse.ok) {
            if (verifyResponse.status === 404) {
              console.warn("‚ö†Ô∏è Payment verification endpoint not found, proceeding with order creation...");
              await createOrderWithPayment('razorpay', paymentResponse);
              return;
            }
            throw new Error(`HTTP error! status: ${verifyResponse.status}`);
          }

          const result = await verifyResponse.json();
          
          if (result.success) {
            showSuccessMessage("Payment verified successfully! Creating your order...");
            await createOrderWithPayment('razorpay', paymentResponse);
          } else {
            throw new Error("Payment verification failed");
          }
        } catch (error) {
          console.error("‚ùå Payment verification error:", error);
          if (error.message.includes('404') || error.message.includes('JSON')) {
            showErrorMessage("Payment verification service unavailable. Creating order anyway...");
            await createOrderWithPayment('razorpay', paymentResponse);
          } else {
            showErrorMessage("Payment verification failed: " + error.message);
          }
        } finally {
          isProcessingPayment = false;
        }
      }

      async function createOrderWithPayment(paymentMethod, paymentResponse = null) {
        const submitBtn = document.getElementById("submitOrder");
        const submitText = document.getElementById("submitText");
        const spinner = document.querySelector(".loading-spinner");

        try {
          console.log("=== STARTING ORDER CREATION WITH PAYMENT ===");

          const token = getAuthToken();
          if (!token) {
            showErrorMessage("Please login first");
            return;
          }

          if (!cartItems || cartItems.length === 0) {
            showErrorMessage("Your cart is empty");
            return;
          }

          const shippingAddress = getShippingAddress();
          const orderData = {
            shippingAddress: shippingAddress,
            paymentMethod: paymentMethod,
            shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
            items: cartItems,
            paymentResponse: paymentResponse
          };

          console.log("üì¶ Final Order Data:", orderData);

          const response = await fetch("http://localhost:5000/api/orders/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });

          const responseText = await response.text();
          console.log("üì® Raw Response:", responseText);

          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error("‚ùå JSON Parse Error:", parseError);
            throw new Error("Server returned invalid JSON: " + responseText);
          }

          if (result.success) {
            console.log("‚úÖ ORDER CREATED SUCCESSFULLY! Order ID:", result.order._id);
            
          
            if (paymentMethod === 'qr') {
              document.getElementById('paymentSuccessModal').classList.remove('hidden');
            }
            
            showSuccessMessage("Order placed successfully!");

            await sendOrderConfirmationEmail(
              orderData, 
              result.order._id, 
              result.order.orderNumber, 
              paymentMethod
            );

            setTimeout(() => {
              window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
            }, paymentMethod === 'qr' ? 3000 : 2000);
          } else {
            throw new Error(result.message || "Failed to create order");
          }
        } catch (err) {
          console.error("üí• FINAL ERROR:", err);
          showErrorMessage("Failed to place order: " + err.message);
        } finally {
          submitBtn.disabled = false;
          submitText.textContent = "Complete Order";
          spinner.style.display = "none";
        }
      }

      async function createOrder(paymentMethod) {
        await createOrderWithPayment(paymentMethod);
      }

      function setupEventListeners() {
  
        document.querySelectorAll(".payment-method").forEach((pm) => {
          pm.addEventListener("click", function () {
            document.querySelectorAll(".payment-method").forEach((m) => m.classList.remove("selected"));
            this.classList.add("selected");
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            handlePaymentMethodChange();
          });
        });

        document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
          radio.addEventListener("change", updateOrderSummary);
        });

      
        document.getElementById('payButton')?.addEventListener('click', function() {
          const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
          
          if (paymentMethod === 'cod') {
         
            document.getElementById('checkoutForm').dispatchEvent(new Event('submit'));
          } else if (paymentMethod === 'qr') {
          
            if (document.getElementById('upiQRContainer').classList.contains('hidden')) {
           
              generateUPIQrCode(orderTotals.total);
              this.innerHTML = '<i class="fas fa-check mr-2"></i> Confirm Payment - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
              document.getElementById('paymentInstructions').textContent = 'After payment, click to confirm and complete order';
            } else {
       
              const confirmed = confirm(`Have you successfully completed the UPI payment of ‚Çπ${orderTotals.total.toLocaleString()}?\n\nPlease ensure you have:\n1. Scanned the QR code\n2. Completed payment in your UPI app\n3. Received payment confirmation`);
              
              if (confirmed) {
                const submitBtn = document.getElementById("submitOrder");
                const submitText = document.getElementById("submitText");
                const spinner = document.querySelector(".loading-spinner");

                submitBtn.disabled = true;
                submitText.textContent = "Processing...";
                spinner.style.display = "inline-block";

                console.log("‚úÖ Creating UPI QR order...");
                createOrder('qr');
              }
            }
          } else {
         
            initiateRazorpayPayment();
          }
        });

        const hamburger = document.querySelector(".hamburger");
        const navMenu = document.querySelector("nav ul");
        if (hamburger) {
          hamburger.addEventListener("click", () => navMenu.classList.toggle("show"));
        }

       
        const checkoutForm = document.getElementById("checkoutForm");
        checkoutForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("üîÑ Form submitted");

          if (!validateForm()) {
            console.log("‚ùå Form validation failed");
            return;
          }

          const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
          if (!paymentMethod) {
            showErrorMessage("Please select a payment method");
            return;
          }

          const submitBtn = document.getElementById("submitOrder");
          const submitText = document.getElementById("submitText");
          const spinner = document.querySelector(".loading-spinner");

          submitBtn.disabled = true;
          submitText.textContent = "Processing...";
          spinner.style.display = "inline-block";

          if (paymentMethod === 'razorpay') {
            initiateRazorpayPayment();
            submitBtn.disabled = false;
            submitText.textContent = "Complete Order";
            spinner.style.display = "none";
            return;
          }

    
          console.log("‚úÖ Creating COD order...");
          await createOrder(paymentMethod);
        });
      }

  
      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ Checkout page loaded");
        fetchCart();
        setupEventListeners();
        
       
        setTimeout(() => {
          handlePaymentMethodChange();
        }, 1500);
      });
    </script>
</body>
</html> 

 -->


<!-- 

 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - SaiKrupa Paithani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="nav.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#800000",
              primaryLight: "#b30000",
              gold: "#D4AF37",
              lightGold: "#F2E8C9",
              cream: "#F8F4E3",
              darkRed: "#680000",
              gray: "#777",
              lightGray: "#f5f5f5",
              white: "#ffffff",
              black: "#333333",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f4e3;
      }
      .checkout-step {
        transition: all 0.3s ease;
      }
      .checkout-step.active {
        border-color: #d4af37;
        background-color: #f8f4e3;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.95);
        color: #800000;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 15px rgba(128, 0, 0, 0.1);
        height: 80px;
      }
      nav ul {
        display: flex;
        list-style: none;
      }
      nav ul li {
        position: relative;
        margin: 0 15px;
      }
      nav ul li a {
        color: #800000;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        padding: 10px 5px;
        display: block;
        position: relative;
      }
      nav ul li a:after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #800000;
        left: 0;
        bottom: 0;
        transition: width 0.3s ease;
      }
      nav ul li a:hover:after {
        width: 100%;
      }
      .nav-icons {
        display: flex;
        align-items: center;
      }
      .nav-icon {
        color: #800000;
        font-size: 1.3rem;
        margin-left: 20px;
        position: relative;
        cursor: pointer;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #800000;
        color: white;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 20px;
        color: #800000;
      }
      .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .payment-method:hover {
        border-color: #d4af37;
      }
      .payment-method.selected {
        border-color: #800000;
        background-color: #f8f4e3;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 20px;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .step.active .step-number {
        background: #800000;
        color: white;
      }
      .step.completed .step-number {
        background: #d4af37;
        color: white;
      }
      .step-text {
        font-size: 0.9rem;
        color: #777;
      }
      .step.active .step-text {
        color: #800000;
        font-weight: 600;
      }
      .loading-spinner {
        display: none;
      }
      .loading-spinner.active {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }
      .qr-code-container {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 15px;
      }
      .qr-code {
        display: inline-block;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
      }
      .upi-instructions {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: left;
      }
      .upi-instructions ol {
        padding-left: 20px;
      }
      .upi-instructions li {
        margin-bottom: 8px;
        color: #555;
      }
      .payment-success-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .payment-success-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      .payment-pending {
        background-color: #fff3cd !important;
        border-color: #ffeaa7 !important;
      }
      @media (max-width: 900px) {
        nav ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          background: rgba(255, 255, 255, 0.98);
          flex-direction: column;
          padding: 20px;
        }
        nav ul.show {
          display: flex;
        }
        nav ul li {
          margin: 10px 0;
          width: 100%;
          text-align: center;
        }
        .hamburger {
          display: block;
        }
      }
    </style>
</head>
<body class="bg-cream">
    <nav>
      <a href="dashboard.html" class="logo flex items-center font-bold text-darkRed">
        <img src="images/logo3.png" alt="Paithani Logo" class="logo-img h-20 w-20 rounded-full mr-3" />
        <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
      </a>
      <ul>
          <li><a href="dashboard.html">Home</a></li>
        <li><a href="product.html">Collections</a></li>
        <li><a href="#testimonials">Testimonials</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-icons">
        <a href="history.html"><div class="nav-icon"><i class="fas fa-shipping-fast mr-2"></i></div></a>
        <div class="nav-icon">
          <a href="cart.html"
            ><i class="fas fa-shopping-cart"></i
            ><span class="cart-count" id="headerCartCount">0</span></a
          >
        </div>
        <div class="hamburger">&#9776;</div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-4 text-gray">
      <a href="dashboard.html"
        ><span class="hover:text-primary cursor-pointer">Home</span> /
      </a>
      <a href="cart.html"
        ><span class="hover:text-primary cursor-pointer">Cart</span> /
      </a>
      <span class="text-primary">Checkout</span>
    </div>

    <div class="container mx-auto px-6 py-6">
      <div class="step-indicator">
        <div class="step completed">
          <div class="step-number"><i class="fas fa-check"></i></div>
          <div class="step-text">Cart</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-text">Information</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">Shipping</div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">Payment</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Checkout</h1>
      <p class="text-gray mb-8">Complete your purchase with secure checkout</p>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <form id="checkoutForm">
          
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step active">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">1</div>
                <h2 class="text-xl font-semibold text-primary">Contact Information</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
                <div>
                  <label for="phone" class="block text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="newsletter" class="mr-2" />
                <label for="newsletter" class="text-gray-700">Email me with news and offers</label>
              </div>
            </div>

         
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">2</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Address</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="firstName" class="block text-gray-700 mb-2">First Name *</label><input type="text" id="firstName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="lastName" class="block text-gray-700 mb-2">Last Name *</label><input type="text" id="lastName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div class="md:col-span-2"><label for="address" class="block text-gray-700 mb-2">Address *</label><input type="text" id="address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="city" class="block text-gray-700 mb-2">City *</label><input type="text" id="city" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div>
                  <label for="state" class="block text-gray-700 mb-2">State *</label>
                  <select id="state" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <option value="">Select State</option>
                    <option value="MH">Maharashtra</option>
                    <option value="DL">Delhi</option>
                    <option value="KA">Karnataka</option>
                    <option value="TN">Tamil Nadu</option>
                    <option value="GJ">Gujarat</option>
                    <option value="UP">Uttar Pradesh</option>
                    <option value="WB">West Bengal</option>
                  </select>
                </div>
                <div><label for="pincode" class="block text-gray-700 mb-2">PIN Code *</label><input type="text" id="pincode" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="saveAddress" class="mr-2" />
                <label for="saveAddress" class="text-gray-700">Save this information for next time</label>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">3</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Method</h2>
              </div>
              <div class="space-y-4">
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="standard" name="shipping" value="standard" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="standard" class="font-medium">Standard Shipping</label>
                      <p class="text-gray text-sm">5-7 business days ‚Ä¢ ‚Çπ200</p>
                    </div>
                    <span class="font-semibold">‚Çπ200</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="express" name="shipping" value="express" class="mr-3" />
                    <div class="flex-1">
                      <label for="express" class="font-medium">Express Shipping</label>
                      <p class="text-gray text-sm">2-3 business days ‚Ä¢ ‚Çπ500</p>
                    </div>
                    <span class="font-semibold">‚Çπ500</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="free" name="shipping" value="free" class="mr-3" />
                    <div class="flex-1">
                      <label for="free" class="font-medium">Free Shipping</label>
                      <p class="text-gray text-sm">7-10 business days ‚Ä¢ Free on orders above ‚Çπ10,000</p>
                    </div>
                    <span class="font-semibold text-green-600">FREE</span>
                  </div>
                </div>
              </div>
            </div>

          
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step" id="paymentSection">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">4</div>
                <h2 class="text-xl font-semibold text-primary">Payment Method</h2>
              </div>

              <div class="space-y-4">
                
                <div class="payment-method selected">
                  <div class="flex items-center">
                    <input type="radio" id="upiQR" name="payment" value="qr" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="upiQR" class="font-medium">UPI QR Code Payment</label>
                      <p class="text-gray text-sm">Scan QR code with any UPI app to pay instantly</p>
                    </div>
                  </div>
                  
                 
                  <div id="upiQRContainer" class="qr-code-container mt-4 hidden">
                    <h4 class="font-semibold text-primary mb-3">Scan to Pay with UPI</h4>
                    <div class="qr-code" id="qrcode"></div>
                    <div class="mt-3">
                      <p class="font-medium">UPI ID: <span class="text-primary" id="displayUpiId">diyawakhare27@okaxis</span></p>
                      <p class="text-sm text-gray">Amount: ‚Çπ<span id="qrAmount">0</span></p>
                    </div>
                    
                    <div class="upi-instructions mt-4">
                      <h5 class="font-semibold mb-2">How to Pay:</h5>
                      <ol class="text-sm">
                        <li>Open any UPI app on your phone (Google Pay, PhonePe, Paytm, etc.)</li>
                        <li>Tap on 'Scan QR Code'</li>
                        <li>Scan the QR code above</li>
                        <li>Verify the amount and UPI ID</li>
                        <li>Enter your UPI PIN to complete payment</li>
                        <li>Click 'Confirm Payment' below after successful payment</li>
                      </ol>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                      <p class="text-sm text-yellow-800 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Important:</strong> After completing payment in your UPI app, return here and click "Confirm Payment"
                      </p>
                    </div>
                  </div>
                </div>

             
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="razorpay" name="payment" value="razorpay" class="mr-3" />
                    <div class="flex-1">
                      <label for="razorpay" class="font-medium">Credit/Debit Card & UPI</label>
                      <p class="text-gray text-sm">Pay securely using card, netbanking, or UPI</p>
                    </div>
                  </div>
                </div>

                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment" value="cod" class="mr-3" />
                    <div class="flex-1">
                      <label for="cod" class="font-medium">Cash on Delivery</label>
                      <p class="text-gray text-sm">Pay when you receive your order (Additional ‚Çπ50 COD charges apply)</p>
                    </div>
                  </div>
                </div>
              </div>

          
              <div class="mt-6 p-4 bg-lightGold rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt text-primary text-xl mr-3"></i>
                  <div>
                    <h4 class="font-semibold text-primary">Your payment is 100% secure</h4>
                    <p class="text-sm text-gray">All transactions are encrypted and secure. We do not store your payment details.</p>
                  </div>
                </div>
              </div>

              
              <div id="paymentButtonContainer" class="mt-6">
                <button type="button" id="payButton" class="w-full bg-primary hover:bg-darkRed text-white py-4 px-6 rounded-lg font-semibold text-lg flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-qrcode mr-2"></i>
                  Show QR Code - ‚Çπ<span id="payAmount">0</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2" id="paymentInstructions">
                  Select payment method and click to proceed
                </p>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <a href="cart.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Cart
              </a>
              <button type="submit" id="submitOrder" class="bg-primary hover:bg-darkRed text-white py-3 px-8 rounded-lg font-semibold text-lg flex items-center">
                <span id="submitText">Complete Order</span>
                <i class="fas fa-lock ml-2"></i>
                <i class="fas fa-spinner loading-spinner ml-2"></i>
              </button>
            </div>
          </form>
        </div>

  
        <div class="lg:w-1/3">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-primary mb-4">Order Summary</h2>
            <div class="mb-6 max-h-80 overflow-y-auto" id="orderItemsContainer"></div>
            <div class="space-y-3 mb-6" id="orderSummary">
              <div class="flex justify-between">
                <span class="text-gray">Subtotal (<span id="summaryItemCount">0</span> items)</span>
                <span class="font-medium" id="subtotalAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Shipping</span>
                <span class="font-medium" id="shippingAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Tax</span>
                <span class="font-medium" id="taxAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-green-600" id="discountSection" style="display: none">
                <span>Discount</span>
                <span id="discountAmount">-‚Çπ0</span>
              </div>
              <div class="flex justify-between text-orange-600" id="codChargesSection" style="display: none">
                <span>COD Charges</span>
                <span id="codChargesAmount">‚Çπ50</span>
              </div>
              <div class="border-t pt-3 flex justify-between text-lg font-bold">
                <span>Total</span>
                <span class="text-primary" id="totalAmount">‚Çπ0</span>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-center mb-3">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                <span class="text-sm font-medium">100% Secure Checkout</span>
              </div>
              <div class="flex justify-center space-x-4">
                <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                <i class="fab fa-google-pay text-2xl text-gray-500"></i>
                <i class="fab fa-amazon-pay text-2xl text-gray-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Need Help?</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <i class="fas fa-phone text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Call Us</p>
                  <p class="text-sm text-gray">+91 98765 43210</p>
                </div>
              </div>
              <div class="flex items-center">
                <i class="fas fa-comments text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Chat with Us</p>
                  <p class="text-sm text-gray">Available 24/7</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-primary text-white mt-12 py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">SaiKrupa Paithani</h3>
            <p class="text-lightGold">Bringing traditional Maharashtrian elegance to your doorstep with authentic handwoven Paithani sarees.</p>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">About Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Collections</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Shipping Policy</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Return Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">Contact Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">FAQs</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Track Order</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Newsletter</h4>
            <p class="text-lightGold mb-4">Subscribe to get special offers and once-in-a-lifetime deals.</p>
            <div class="flex">
              <input type="email" placeholder="Your email" class="px-4 py-2 rounded-l-lg w-full text-black" />
              <button class="bg-gold text-black px-4 py-2 rounded-r-lg font-semibold">Subscribe</button>
            </div>
          </div>
        </div>
        <div class="border-t border-primaryLight mt-8 pt-8 text-center">
          <p>¬© 2025 SaiKrupa Paithani. All rights reserved.</p>
        </div>
      </div>
    </footer>


    <div id="paymentSuccessModal" class="payment-success-modal hidden">
      <div class="payment-success-content">
        <div class="text-green-500 text-6xl mb-4">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful!</h3>
        <p class="text-gray-600 mb-6">Your payment has been processed successfully. Redirecting to order confirmation...</p>
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
      </div>
    </div>

    <script>
  let cartItems = [];
  let orderTotals = {
    subtotal: 0,
    shipping: 0,
    tax: 0,
    discount: 0,
    codCharges: 0,
    total: 0,
  };
  let razorpayOrderId = null;
  let isProcessingPayment = false;
  let qrCode = null;
  let upiPaymentInitiated = false;
  let upiPaymentVerified = false;

  function getAuthToken() {
    return localStorage.getItem("authToken") || localStorage.getItem("token");
  }

  function checkAuth() {
    const token = getAuthToken();
    if (!token) {
      alert("Please login to proceed with checkout");
      window.location.href = "signup_login.html";
      return false;
    }
    return true;
  }

  function showSuccessMessage(msg) {
    const notif = document.createElement("div");
    notif.className = "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
    notif.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>${msg}</span></div>`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
  }

  function showErrorMessage(msg) {
    const notif = document.createElement("div");
    notif.className = "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
    notif.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>${msg}</span></div>`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
  }

  function generateUPIQrCode(amount) {
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = ''; 
    
    const upiId = "rahulbhandge@ybl"; 
    const merchantName = "SaiKrupa Paithani";
    
    const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=Order+Payment+for+SaiKrupa+Paithani`;
    
    console.log("Generating QR for UPI:", upiLink);
    
    qrCode = new QRCode(qrContainer, {
      text: upiLink,
      width: 200,
      height: 200,
      colorDark: "#800000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
    
    document.getElementById('qrAmount').textContent = amount.toLocaleString();
    document.getElementById('displayUpiId').textContent = upiId;
    document.getElementById('upiQRContainer').classList.remove('hidden');
    
    upiPaymentInitiated = true;
  }

  async function fetchCart() {
    if (!checkAuth()) return;

    try {
      const token = getAuthToken();
      console.log("üîÑ Fetching cart data...");

      const res = await fetch("http://localhost:5000/api/cart", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!res.ok) {
        if (res.status === 401) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("token");
          window.location.href = "signup_login.html";
          return;
        }
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const result = await res.json();
      console.log("üì¶ Cart API response:", result);

      if (result.success && result.cart) {
        cartItems = result.cart.items.map((item) => {
          const product = item.productId;
          return {
            productId: product._id,
            name: product.name || "Product",
            image: product.images?.[0] || "images/default.jpg",
            price: item.price || product.price || 0,
            quantity: item.quantity || 1,
          };
        });

        console.log("üõí Processed cart items:", cartItems);

        if (cartItems.length === 0) {
          showErrorMessage("Your cart is empty");
          setTimeout(() => {
            window.location.href = "cart.html";
          }, 2000);
          return;
        }

        renderOrderItems();
        updateOrderSummary();
        updateCartCount();
      } else {
        throw new Error(result.message || "Failed to fetch cart");
      }
    } catch (err) {
      console.error("‚ùå Fetch cart error:", err);
      showErrorMessage("Failed to load cart items: " + err.message);
    }
  }

  function renderOrderItems() {
    const container = document.getElementById("orderItemsContainer");
    container.innerHTML = cartItems.map((item) => {
      const itemTotal = item.price * item.quantity;
      return `
        <div class="flex border-b border-gray-200 py-4">
          <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex items-center justify-center">
            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
          </div>
          <div class="flex-1">
            <h3 class="font-medium text-primary">${item.name}</h3>
            <p class="text-gray text-sm">Qty: ${item.quantity}</p>
            <p class="text-primary font-semibold">‚Çπ${itemTotal.toLocaleString()}</p>
          </div>
        </div>
      `;
    }).join("");
  }

  function updateOrderSummary() {
    const subtotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

    const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
    let shipping = 0;
    if (shippingMethod === "express") shipping = 500;
    else if (shippingMethod === "standard") shipping = 200;
    else if (shippingMethod === "free") shipping = subtotal > 10000 ? 0 : 200;

    const tax = Math.round(subtotal * 0.02);
    const discount = subtotal > 5000 ? Math.round(subtotal * 0.1) : 0;
    
    const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
    const codCharges = paymentMethod === 'cod' ? 50 : 0;
    
    const total = subtotal + shipping + tax - discount + codCharges;

    orderTotals = { subtotal, shipping, tax, discount, codCharges, total };

    document.getElementById("summaryItemCount").textContent = itemCount;
    document.getElementById("subtotalAmount").textContent = `‚Çπ${subtotal.toLocaleString()}`;
    document.getElementById("shippingAmount").textContent = shipping === 0 ? "FREE" : `‚Çπ${shipping}`;
    document.getElementById("taxAmount").textContent = `‚Çπ${tax.toLocaleString()}`;
    document.getElementById("totalAmount").textContent = `‚Çπ${total.toLocaleString()}`;

    const discountSection = document.getElementById("discountSection");
    const discountAmount = document.getElementById("discountAmount");
    if (discount > 0) {
      discountSection.style.display = "flex";
      discountAmount.textContent = `-‚Çπ${discount.toLocaleString()}`;
    } else {
      discountSection.style.display = "none";
    }

    const codSection = document.getElementById("codChargesSection");
    if (codCharges > 0) {
      codSection.style.display = "flex";
    } else {
      codSection.style.display = "none";
    }

    if (document.getElementById('payAmount')) {
      document.getElementById('payAmount').textContent = total.toLocaleString();
    }
  }

  function updateCartCount() {
    const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById("headerCartCount").textContent = totalItems;
  }

  function getShippingAddress() {
    return {
      firstName: document.getElementById("firstName").value,
      lastName: document.getElementById("lastName").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value,
      address: document.getElementById("address").value,
      city: document.getElementById("city").value,
      state: document.getElementById("state").value,
      pincode: document.getElementById("pincode").value,
    };
  }

  function validateForm() {
    const requiredFields = [
      "email", "phone", "firstName", "lastName", "address", "city", "state", "pincode",
    ];
    for (let field of requiredFields) {
      const el = document.getElementById(field);
      if (!el.value.trim()) {
        showErrorMessage(`Please fill in the ${field}`);
        el.focus();
        return false;
      }
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(document.getElementById("email").value)) {
      showErrorMessage("Invalid email");
      return false;
    }

    const phoneRegex = /^[6-9]\d{9}$/;
    if (!phoneRegex.test(document.getElementById("phone").value.replace(/\D/g, ""))) {
      showErrorMessage("Invalid 10-digit phone number");
      return false;
    }

    return true;
  }

  function handlePaymentMethodChange() {
    const selectedMethod = document.querySelector('input[name="payment"]:checked').value;
    const payButton = document.getElementById('payButton');
    const paymentInstructions = document.getElementById('paymentInstructions');
    
    upiPaymentInitiated = false;
    upiPaymentVerified = false;
    

    document.getElementById('upiQRContainer').classList.add('hidden');
    
    if (selectedMethod === 'cod') {
      payButton.innerHTML = '<i class="fas fa-box mr-2"></i> Place COD Order - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      paymentInstructions.textContent = 'Pay when you receive your order';
      payButton.disabled = false;
    } else if (selectedMethod === 'qr') {
      payButton.innerHTML = '<i class="fas fa-qrcode mr-2"></i> Show QR Code - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      paymentInstructions.textContent = 'Click to generate QR code for UPI payment';
      payButton.disabled = false;
    } else {
      payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      paymentInstructions.textContent = 'You will be redirected to secure payment page';
      payButton.disabled = false;
    }
    
    updateOrderSummary();
  }


  async function initiateRazorpayPayment() {
    if (isProcessingPayment) return;
    
    try {
      isProcessingPayment = true;
      const payButton = document.getElementById('payButton');
      const originalText = payButton.innerHTML;
      
      payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
      payButton.disabled = true;

      const token = getAuthToken();
      const response = await fetch('http://localhost:5000/api/payments/create-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          amount: orderTotals.total * 100,
          currency: 'INR',
          receipt: `receipt_${Date.now()}`
        })
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.message);
      }

      
      const options = {
        key: 'rzp_test_Rg2ZENKibKx5N2',
        amount: result.order.amount,
        currency: result.order.currency,
        name: "SaiKrupa Paithani",
        description: "Purchase of Paithani Products",
        order_id: result.order.id,
        handler: async function(response) {
          await handlePaymentSuccess(response);
        },
        prefill: {
          name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
          email: document.getElementById('email').value,
          contact: document.getElementById('phone').value
        },
        notes: {
          address: "SaiKrupa Paithani Store"
        },
        theme: {
          color: "#800000"
        },
        method: {
          netbanking: true,
          card: true,
          upi: true,
          wallet: true
        },
        modal: {
          ondismiss: function() {
            isProcessingPayment = false;
            payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
            payButton.disabled = false;
            console.log("Payment modal closed");
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
      
    } catch (error) {
      console.error("‚ùå Payment initiation error:", error);
      showErrorMessage("Failed to initiate payment: " + error.message);
      isProcessingPayment = false;
      
      const payButton = document.getElementById('payButton');
      payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      payButton.disabled = false;
    }
  }

  async function handlePaymentSuccess(paymentResponse) {
    try {
      console.log("‚úÖ Payment successful:", paymentResponse);
      
      const token = getAuthToken();
      
      try {
        const verifyResponse = await fetch('http://localhost:5000/api/payments/verify-payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            razorpay_order_id: paymentResponse.razorpay_order_id,
            razorpay_payment_id: paymentResponse.razorpay_payment_id,
            razorpay_signature: paymentResponse.razorpay_signature
          })
        });

        if (verifyResponse.ok) {
          const result = await verifyResponse.json();
          if (result.success) {
            console.log("‚úÖ Payment verified successfully");
          }
        }
      } catch (verifyError) {
        console.log("‚ö†Ô∏è Payment verification skipped:", verifyError.message);
      }

      await createOrderWithPayment('razorpay', paymentResponse);
    } catch (error) {
      console.error("‚ùå Payment processing error:", error);
      showErrorMessage("Payment processing failed: " + error.message);
    } finally {
      isProcessingPayment = false;
    }
  }

  async function createOrderWithPayment(paymentMethod, paymentResponse = null) {
    const submitBtn = document.getElementById("submitOrder");
    const submitText = document.getElementById("submitText");
    const spinner = document.querySelector(".loading-spinner");

    try {
      console.log("=== STARTING ORDER CREATION WITH PAYMENT ===");

      const token = getAuthToken();
      if (!token) {
        showErrorMessage("Please login first");
        return;
      }

      if (!cartItems || cartItems.length === 0) {
        showErrorMessage("Your cart is empty");
        return;
      }

      const shippingAddress = getShippingAddress();
      const orderData = {
        shippingAddress: shippingAddress,
        paymentMethod: paymentMethod,
        shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
        items: cartItems,
        paymentResponse: paymentResponse
      };

      console.log("üì¶ Final Order Data:", orderData);

      const response = await fetch("http://localhost:5000/api/orders/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(orderData),
      });

      const responseText = await response.text();
      console.log("üì® Raw Response:", responseText);

      let result;
      try {
        result = JSON.parse(responseText);
      } catch (parseError) {
        console.error("‚ùå JSON Parse Error:", parseError);
        throw new Error("Server returned invalid JSON: " + responseText);
      }

      if (result.success) {
        console.log("‚úÖ ORDER CREATED SUCCESSFULLY! Order ID:", result.order._id);
        
        showSuccessMessage("Order placed successfully! Confirmation email sent.");
        
        if (paymentMethod === 'qr') {
          document.getElementById('paymentSuccessModal').classList.remove('hidden');
        }

        setTimeout(() => {
          window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
        }, paymentMethod === 'qr' ? 3000 : 2000);
      } else {
        throw new Error(result.message || "Failed to create order");
      }
    } catch (err) {
      console.error("üí• FINAL ERROR:", err);
      showErrorMessage("Failed to place order: " + err.message);
    } finally {
      submitBtn.disabled = false;
      submitText.textContent = "Complete Order";
      spinner.style.display = "none";
    }
  }

  function setupEventListeners() {
    document.querySelectorAll(".payment-method").forEach((pm) => {
      pm.addEventListener("click", function () {
        document.querySelectorAll(".payment-method").forEach((m) => m.classList.remove("selected"));
        this.classList.add("selected");
        const radio = this.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;
        handlePaymentMethodChange();
      });
    });

    document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
      radio.addEventListener("change", updateOrderSummary);
    });

    document.getElementById('payButton')?.addEventListener('click', async function() {
      const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
      
      if (paymentMethod === 'cod') {
        document.getElementById('checkoutForm').dispatchEvent(new Event('submit'));
      } else if (paymentMethod === 'qr') {
        if (!upiPaymentInitiated) {
          generateUPIQrCode(orderTotals.total);
          this.innerHTML = '<i class="fas fa-check mr-2"></i> Confirm Payment - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          document.getElementById('paymentInstructions').textContent = 'After payment, click to confirm and complete order';
          this.disabled = false;
        } else {
          if (!upiPaymentVerified) {
            const confirmed = confirm(`Have you successfully completed the UPI payment of ‚Çπ${orderTotals.total.toLocaleString()}?\n\nPlease ensure you have:\n‚úÖ Scanned the QR code\n‚úÖ Completed payment in your UPI app\n‚úÖ Received payment confirmation\n\nClick OK only if payment was successful.`);
            
            if (confirmed) {
              upiPaymentVerified = true;
              const submitBtn = document.getElementById("submitOrder");
              const submitText = document.getElementById("submitText");
              const spinner = document.querySelector(".loading-spinner");

              submitBtn.disabled = true;
              submitText.textContent = "Processing...";
              spinner.style.display = "inline-block";

              console.log("‚úÖ Creating UPI QR order...");
              await createOrderWithPayment('qr');
            }
          }
        }
      } else {
        initiateRazorpayPayment();
      }
    });

    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector("nav ul");
    if (hamburger) {
      hamburger.addEventListener("click", () => navMenu.classList.toggle("show"));
    }

    const checkoutForm = document.getElementById("checkoutForm");
    checkoutForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      console.log("üîÑ Form submitted");

      if (!validateForm()) {
        console.log("‚ùå Form validation failed");
        return;
      }

      const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
      if (!paymentMethod) {
        showErrorMessage("Please select a payment method");
        return;
      }

      if (paymentMethod === 'cod' || (paymentMethod === 'qr' && upiPaymentVerified)) {
        const submitBtn = document.getElementById("submitOrder");
        const submitText = document.getElementById("submitText");
        const spinner = document.querySelector(".loading-spinner");

        submitBtn.disabled = true;
        submitText.textContent = "Processing...";
        spinner.style.display = "inline-block";

        console.log(`‚úÖ Creating ${paymentMethod} order...`);
        await createOrderWithPayment(paymentMethod);
        return;
      }

      if (paymentMethod === 'qr' && !upiPaymentVerified) {
        showErrorMessage("Please complete the UPI payment process first. Click 'Show QR Code' and then 'Confirm Payment' after payment.");
        return;
      }

      if (paymentMethod === 'razorpay') {
        showErrorMessage("Please click the 'Pay Securely' button to complete your payment.");
        return;
      }
    });
  }

  
  document.addEventListener("DOMContentLoaded", () => {
    console.log("üöÄ Checkout page loaded");
    fetchCart();
    setupEventListeners();
    

    setTimeout(() => {
      handlePaymentMethodChange();
    }, 1500);
  });
</script></body>
</html> -->

<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - SaiKrupa Paithani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="nav.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#800000",
              primaryLight: "#b30000",
              gold: "#D4AF37",
              lightGold: "#F2E8C9",
              cream: "#F8F4E3",
              darkRed: "#680000",
              gray: "#777",
              lightGray: "#f5f5f5",
              white: "#ffffff",
              black: "#333333",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f4e3;
      }
      .checkout-step {
        transition: all 0.3s ease;
      }
      .checkout-step.active {
        border-color: #d4af37;
        background-color: #f8f4e3;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.95);
        color: #800000;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 15px rgba(128, 0, 0, 0.1);
        height: 80px;
      }
      nav ul {
        display: flex;
        list-style: none;
      }
      nav ul li {
        position: relative;
        margin: 0 15px;
      }
      nav ul li a {
        color: #800000;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        padding: 10px 5px;
        display: block;
        position: relative;
      }
      nav ul li a:after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #800000;
        left: 0;
        bottom: 0;
        transition: width 0.3s ease;
      }
      nav ul li a:hover:after {
        width: 100%;
      }
      .nav-icons {
        display: flex;
        align-items: center;
      }
      .nav-icon {
        color: #800000;
        font-size: 1.3rem;
        margin-left: 20px;
        position: relative;
        cursor: pointer;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #800000;
        color: white;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 20px;
        color: #800000;
      }
      .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .payment-method:hover {
        border-color: #d4af37;
      }
      .payment-method.selected {
        border-color: #800000;
        background-color: #f8f4e3;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 20px;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .step.active .step-number {
        background: #800000;
        color: white;
      }
      .step.completed .step-number {
        background: #d4af37;
        color: white;
      }
      .step-text {
        font-size: 0.9rem;
        color: #777;
      }
      .step.active .step-text {
        color: #800000;
        font-weight: 600;
      }
      .loading-spinner {
        display: none;
      }
      .loading-spinner.active {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }
      .qr-code-container {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 15px;
      }
      .qr-code {
        display: inline-block;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
      }
      .upi-instructions {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: left;
      }
      .upi-instructions ol {
        padding-left: 20px;
      }
      .upi-instructions li {
        margin-bottom: 8px;
        color: #555;
      }
      .payment-success-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .payment-success-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      .payment-pending {
        background-color: #fff3cd !important;
        border-color: #ffeaa7 !important;
      }
      @media (max-width: 900px) {
        nav ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          background: rgba(255, 255, 255, 0.98);
          flex-direction: column;
          padding: 20px;
        }
        nav ul.show {
          display: flex;
        }
        nav ul li {
          margin: 10px 0;
          width: 100%;
          text-align: center;
        }
        .hamburger {
          display: block;
        }
      }
    </style>
</head>
<body class="bg-cream">
    <nav>
      <a href="dashboard.html" class="logo flex items-center font-bold text-darkRed">
        <img src="images/logo3.png" alt="Paithani Logo" class="logo-img h-20 w-20 rounded-full mr-3" />
        <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
      </a>
      <ul>
          <li><a href="dashboard.html">Home</a></li>
        <li><a href="product.html">Collections</a></li>
        <li><a href="#testimonials">Testimonials</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-icons">
        <a href="history.html"><div class="nav-icon"><i class="fas fa-shipping-fast mr-2"></i></div></a>
        <div class="nav-icon">
          <a href="cart.html"
            ><i class="fas fa-shopping-cart"></i
            ><span class="cart-count" id="headerCartCount">0</span></a
          >
        </div>
        <div class="hamburger">&#9776;</div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-4 text-gray">
      <a href="dashboard.html"
        ><span class="hover:text-primary cursor-pointer">Home</span> /
      </a>
      <a href="cart.html"
        ><span class="hover:text-primary cursor-pointer">Cart</span> /
      </a>
      <span class="text-primary">Checkout</span>
    </div>

    <div class="container mx-auto px-6 py-6">
      <div class="step-indicator">
        <div class="step completed">
          <div class="step-number"><i class="fas fa-check"></i></div>
          <div class="step-text">Cart</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-text">Information</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">Shipping</div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">Payment</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Checkout</h1>
      <p class="text-gray mb-8">Complete your purchase with secure checkout</p>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <form id="checkoutForm">
          
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step active">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">1</div>
                <h2 class="text-xl font-semibold text-primary">Contact Information</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
                <div>
                  <label for="phone" class="block text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="newsletter" class="mr-2" />
                <label for="newsletter" class="text-gray-700">Email me with news and offers</label>
              </div>
            </div>

         
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">2</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Address</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="firstName" class="block text-gray-700 mb-2">First Name *</label><input type="text" id="firstName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="lastName" class="block text-gray-700 mb-2">Last Name *</label><input type="text" id="lastName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div class="md:col-span-2"><label for="address" class="block text-gray-700 mb-2">Address *</label><input type="text" id="address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="city" class="block text-gray-700 mb-2">City *</label><input type="text" id="city" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div>
                  <label for="state" class="block text-gray-700 mb-2">State *</label>
                  <select id="state" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <option value="">Select State</option>
                    <option value="MH">Maharashtra</option>
                    <option value="DL">Delhi</option>
                    <option value="KA">Karnataka</option>
                    <option value="TN">Tamil Nadu</option>
                    <option value="GJ">Gujarat</option>
                    <option value="UP">Uttar Pradesh</option>
                    <option value="WB">West Bengal</option>
                  </select>
                </div>
                <div><label for="pincode" class="block text-gray-700 mb-2">PIN Code *</label><input type="text" id="pincode" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="saveAddress" class="mr-2" />
                <label for="saveAddress" class="text-gray-700">Save this information for next time</label>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">3</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Method</h2>
              </div>
              <div class="space-y-4">
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="standard" name="shipping" value="standard" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="standard" class="font-medium">Standard Shipping</label>
                      <p class="text-gray text-sm">5-7 business days ‚Ä¢ ‚Çπ200</p>
                    </div>
                    <span class="font-semibold">‚Çπ200</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="express" name="shipping" value="express" class="mr-3" />
                    <div class="flex-1">
                      <label for="express" class="font-medium">Express Shipping</label>
                      <p class="text-gray text-sm">2-3 business days ‚Ä¢ ‚Çπ500</p>
                    </div>
                    <span class="font-semibold">‚Çπ500</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="free" name="shipping" value="free" class="mr-3" />
                    <div class="flex-1">
                      <label for="free" class="font-medium">Free Shipping</label>
                      <p class="text-gray text-sm">7-10 business days ‚Ä¢ Free on orders above ‚Çπ10,000</p>
                    </div>
                    <span class="font-semibold text-green-600">FREE</span>
                  </div>
                </div>
              </div>
            </div>

          
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step" id="paymentSection">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">4</div>
                <h2 class="text-xl font-semibold text-primary">Payment Method</h2>
              </div>

              <div class="space-y-4">
                
                <div class="payment-method selected">
                  <div class="flex items-center">
                    <input type="radio" id="upiQR" name="payment" value="qr" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="upiQR" class="font-medium">UPI QR Code Payment</label>
                      <p class="text-gray text-sm">Scan QR code with any UPI app to pay instantly</p>
                    </div>
                  </div>
                  
                 
                  <div id="upiQRContainer" class="qr-code-container mt-4 hidden">
                    <h4 class="font-semibold text-primary mb-3">Scan to Pay with UPI</h4>
                    <div class="qr-code" id="qrcode"></div>
                    <div class="mt-3">
                      <p class="font-medium">UPI ID: <span class="text-primary" id="displayUpiId">paithanistore@cashfree</span></p>
                      <p class="text-sm text-gray">Amount: ‚Çπ<span id="qrAmount">0</span></p>
                    </div>
                    
                    <div class="upi-instructions mt-4">
                      <h5 class="font-semibold mb-2">How to Pay:</h5>
                      <ol class="text-sm">
                        <li>Open any UPI app on your phone (Google Pay, PhonePe, Paytm, etc.)</li>
                        <li>Tap on 'Scan QR Code'</li>
                        <li>Scan the QR code above</li>
                        <li>Verify the amount and UPI ID</li>
                        <li>Enter your UPI PIN to complete payment</li>
                        <li>Click 'Confirm Payment' below after successful payment</li>
                      </ol>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                      <p class="text-sm text-yellow-800 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Important:</strong> After completing payment in your UPI app, return here and click "Confirm Payment"
                      </p>
                    </div>
                  </div>
                </div>

             
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="cashfree" name="payment" value="cashfree" class="mr-3" />
                    <div class="flex-1">
                      <label for="cashfree" class="font-medium">Credit/Debit Card, UPI & Net Banking</label>
                      <p class="text-gray text-sm">Pay securely using Cashfree (Cards, UPI, Net Banking, Wallets)</p>
                    </div>
                  </div>
                </div>

                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment" value="cod" class="mr-3" />
                    <div class="flex-1">
                      <label for="cod" class="font-medium">Cash on Delivery</label>
                      <p class="text-gray text-sm">Pay when you receive your order (Additional ‚Çπ50 COD charges apply)</p>
                    </div>
                  </div>
                </div>
              </div>

          
              <div class="mt-6 p-4 bg-lightGold rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt text-primary text-xl mr-3"></i>
                  <div>
                    <h4 class="font-semibold text-primary">Your payment is 100% secure</h4>
                    <p class="text-sm text-gray">All transactions are encrypted and secure. We do not store your payment details.</p>
                  </div>
                </div>
              </div>

              
              <div id="paymentButtonContainer" class="mt-6">
                <button type="button" id="payButton" class="w-full bg-primary hover:bg-darkRed text-white py-4 px-6 rounded-lg font-semibold text-lg flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-qrcode mr-2"></i>
                  Show QR Code - ‚Çπ<span id="payAmount">0</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2" id="paymentInstructions">
                  Select payment method and click to proceed
                </p>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <a href="cart.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Cart
              </a>
              <button type="submit" id="submitOrder" class="bg-primary hover:bg-darkRed text-white py-3 px-8 rounded-lg font-semibold text-lg flex items-center">
                <span id="submitText">Complete Order</span>
                <i class="fas fa-lock ml-2"></i>
                <i class="fas fa-spinner loading-spinner ml-2"></i>
              </button>
            </div>
          </form>
        </div>

  
        <div class="lg:w-1/3">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-primary mb-4">Order Summary</h2>
            <div class="mb-6 max-h-80 overflow-y-auto" id="orderItemsContainer"></div>
            <div class="space-y-3 mb-6" id="orderSummary">
              <div class="flex justify-between">
                <span class="text-gray">Subtotal (<span id="summaryItemCount">0</span> items)</span>
                <span class="font-medium" id="subtotalAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Shipping</span>
                <span class="font-medium" id="shippingAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Tax</span>
                <span class="font-medium" id="taxAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-green-600" id="discountSection" style="display: none">
                <span>Discount</span>
                <span id="discountAmount">-‚Çπ0</span>
              </div>
              <div class="flex justify-between text-orange-600" id="codChargesSection" style="display: none">
                <span>COD Charges</span>
                <span id="codChargesAmount">‚Çπ50</span>
              </div>
              <div class="border-t pt-3 flex justify-between text-lg font-bold">
                <span>Total</span>
                <span class="text-primary" id="totalAmount">‚Çπ0</span>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-center mb-3">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                <span class="text-sm font-medium">100% Secure Checkout</span>
              </div>
              <div class="flex justify-center space-x-4">
                <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                <i class="fab fa-google-pay text-2xl text-gray-500"></i>
                <i class="fab fa-amazon-pay text-2xl text-gray-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Need Help?</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <i class="fas fa-phone text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Call Us</p>
                  <p class="text-sm text-gray">+91 98765 43210</p>
                </div>
              </div>
              <div class="flex items-center">
                <i class="fas fa-comments text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Chat with Us</p>
                  <p class="text-sm text-gray">Available 24/7</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-primary text-white mt-12 py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">SaiKrupa Paithani</h3>
            <p class="text-lightGold">Bringing traditional Maharashtrian elegance to your doorstep with authentic handwoven Paithani sarees.</p>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">About Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Collections</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Shipping Policy</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Return Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">Contact Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">FAQs</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Track Order</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Newsletter</h4>
            <p class="text-lightGold mb-4">Subscribe to get special offers and once-in-a-lifetime deals.</p>
            <div class="flex">
              <input type="email" placeholder="Your email" class="px-4 py-2 rounded-l-lg w-full text-black" />
              <button class="bg-gold text-black px-4 py-2 rounded-r-lg font-semibold">Subscribe</button>
            </div>
          </div>
        </div>
        <div class="border-t border-primaryLight mt-8 pt-8 text-center">
          <p>¬© 2025 SaiKrupa Paithani. All rights reserved.</p>
        </div>
      </div>
    </footer>


    <div id="paymentSuccessModal" class="payment-success-modal hidden">
      <div class="payment-success-content">
        <div class="text-green-500 text-6xl mb-4">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful!</h3>
        <p class="text-gray-600 mb-6">Your payment has been processed successfully. Redirecting to order confirmation...</p>
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
      </div>
    </div>

   <script>
  let cartItems = [];
  let orderTotals = {
    subtotal: 0,
    shipping: 0,
    tax: 0,
    discount: 0,
    codCharges: 0,
    total: 0,
  };
  let cashfreeOrderId = null;
  let isProcessingPayment = false;
  let qrCode = null;
  let upiPaymentInitiated = false;
  let upiPaymentVerified = false;

  function getAuthToken() {
    return localStorage.getItem("authToken") || localStorage.getItem("token");
  }

  function checkAuth() {
    const token = getAuthToken();
    if (!token) {
      alert("Please login to proceed with checkout");
      window.location.href = "signup_login.html";
      return false;
    }
    return true;
  }

  function showSuccessMessage(msg) {
    const notif = document.createElement("div");
    notif.className = "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
    notif.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>${msg}</span></div>`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
  }

  function showErrorMessage(msg) {
    const notif = document.createElement("div");
    notif.className = "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
    notif.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>${msg}</span></div>`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
  }

  function generateUPIQrCode(amount) {
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = ''; 
    
    const upiId = "rahulbhandge@ybl"; 
    const merchantName = "SaiKrupa Paithani";
    
    const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=Order+Payment+for+SaiKrupa+Paithani`;
    
    console.log("Generating QR for UPI:", upiLink);
    
    qrCode = new QRCode(qrContainer, {
      text: upiLink,
      width: 200,
      height: 200,
      colorDark: "#800000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
    
    document.getElementById('qrAmount').textContent = amount.toLocaleString();
    document.getElementById('displayUpiId').textContent = upiId;
    document.getElementById('upiQRContainer').classList.remove('hidden');
    
    upiPaymentInitiated = true;
  }
  async function fetchCart() {
    if (!checkAuth()) return;

    try {
      const token = getAuthToken();
      console.log("üîÑ Fetching cart data...");

      const res = await fetch("http://localhost:5000/api/cart", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!res.ok) {
        if (res.status === 401) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("token");
          window.location.href = "signup_login.html";
          return;
        }
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const result = await res.json();
      console.log("üì¶ Cart API response:", result);

      if (result.success && result.cart) {
        cartItems = result.cart.items.map((item) => {
          const product = item.productId;
          return {
            productId: product._id,
            name: product.name || "Product",
            image: product.images?.[0] || "images/default.jpg",
            price: item.price || product.price || 0,
            quantity: item.quantity || 1,
          };
        });

        console.log("üõí Processed cart items:", cartItems);

        if (cartItems.length === 0) {
          showErrorMessage("Your cart is empty");
          setTimeout(() => {
            window.location.href = "cart.html";
          }, 2000);
          return;
        }

        renderOrderItems();
        updateOrderSummary();
        updateCartCount();
      } else {
        throw new Error(result.message || "Failed to fetch cart");
      }
    } catch (err) {
      console.error("‚ùå Fetch cart error:", err);
      showErrorMessage("Failed to load cart items: " + err.message);
    }
  }

  function renderOrderItems() {
    const container = document.getElementById("orderItemsContainer");
    container.innerHTML = cartItems.map((item) => {
      const itemTotal = item.price * item.quantity;
      return `
        <div class="flex border-b border-gray-200 py-4">
          <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex items-center justify-center">
            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
          </div>
          <div class="flex-1">
            <h3 class="font-medium text-primary">${item.name}</h3>
            <p class="text-gray text-sm">Qty: ${item.quantity}</p>
            <p class="text-primary font-semibold">‚Çπ${itemTotal.toLocaleString()}</p>
          </div>
        </div>
      `;
    }).join("");
  }

  function updateOrderSummary() {
    const subtotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

    const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
    let shipping = 0;
    if (shippingMethod === "express") shipping = 500;
    else if (shippingMethod === "standard") shipping = 200;
    else if (shippingMethod === "free") shipping = subtotal > 10000 ? 0 : 200;

    const tax = Math.round(subtotal * 0.02);
    const discount = subtotal > 5000 ? Math.round(subtotal * 0.1) : 0;
    
    const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
    const codCharges = paymentMethod === 'cod' ? 50 : 0;
    
    const total = subtotal + shipping + tax - discount + codCharges;

    orderTotals = { subtotal, shipping, tax, discount, codCharges, total };

    document.getElementById("summaryItemCount").textContent = itemCount;
    document.getElementById("subtotalAmount").textContent = `‚Çπ${subtotal.toLocaleString()}`;
    document.getElementById("shippingAmount").textContent = shipping === 0 ? "FREE" : `‚Çπ${shipping}`;
    document.getElementById("taxAmount").textContent = `‚Çπ${tax.toLocaleString()}`;
    document.getElementById("totalAmount").textContent = `‚Çπ${total.toLocaleString()}`;

    const discountSection = document.getElementById("discountSection");
    const discountAmount = document.getElementById("discountAmount");
    if (discount > 0) {
      discountSection.style.display = "flex";
      discountAmount.textContent = `-‚Çπ${discount.toLocaleString()}`;
    } else {
      discountSection.style.display = "none";
    }

    const codSection = document.getElementById("codChargesSection");
    if (codCharges > 0) {
      codSection.style.display = "flex";
    } else {
      codSection.style.display = "none";
    }

    if (document.getElementById('payAmount')) {
      document.getElementById('payAmount').textContent = total.toLocaleString();
    }
  }

  function updateCartCount() {
    const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById("headerCartCount").textContent = totalItems;
  }

  function getShippingAddress() {
    return {
      firstName: document.getElementById("firstName").value,
      lastName: document.getElementById("lastName").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value,
      address: document.getElementById("address").value,
      city: document.getElementById("city").value,
      state: document.getElementById("state").value,
      pincode: document.getElementById("pincode").value,
    };
  }

  function validateForm() {
    const requiredFields = [
      "email", "phone", "firstName", "lastName", "address", "city", "state", "pincode",
    ];
    for (let field of requiredFields) {
      const el = document.getElementById(field);
      if (!el.value.trim()) {
        showErrorMessage(`Please fill in the ${field}`);
        el.focus();
        return false;
      }
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(document.getElementById("email").value)) {
      showErrorMessage("Invalid email");
      return false;
    }

    const phoneRegex = /^[6-9]\d{9}$/;
    if (!phoneRegex.test(document.getElementById("phone").value.replace(/\D/g, ""))) {
      showErrorMessage("Invalid 10-digit phone number");
      return false;
    }

    return true;
  }

  function handlePaymentMethodChange() {
    const selectedMethod = document.querySelector('input[name="payment"]:checked').value;
    const payButton = document.getElementById('payButton');
    const paymentInstructions = document.getElementById('paymentInstructions');
    
    upiPaymentInitiated = false;
    upiPaymentVerified = false;
    
    document.getElementById('upiQRContainer').classList.add('hidden');
    
    if (selectedMethod === 'cod') {
      payButton.innerHTML = '<i class="fas fa-box mr-2"></i> Place COD Order - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      paymentInstructions.textContent = 'Pay when you receive your order';
      payButton.disabled = false;
    } else if (selectedMethod === 'qr') {
      payButton.innerHTML = '<i class="fas fa-qrcode mr-2"></i> Show QR Code - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      paymentInstructions.textContent = 'Click to generate QR code for UPI payment';
      payButton.disabled = false;
    } else if (selectedMethod === 'cashfree') {
      payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      paymentInstructions.textContent = 'You will be redirected to secure Cashfree payment page';
      payButton.disabled = false;
    }
    
    updateOrderSummary();
  }

  async function initiateCashfreePayment() {
    if (isProcessingPayment) return;
    
    try {
      isProcessingPayment = true;
      const payButton = document.getElementById('payButton');
      const originalText = payButton.innerHTML;
      
      payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
      payButton.disabled = true;

      const token = getAuthToken();
      
      const customerDetails = {
        customer_id: `user_${Date.now()}`, 
        customer_email: document.getElementById('email').value,
        customer_phone: document.getElementById('phone').value,
        customer_name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`
      };

      console.log("üí∞ Creating Cashfree order for amount:", orderTotals.total);

      const response = await fetch('http://localhost:5000/api/payments/create-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          amount: orderTotals.total,
          currency: 'INR',
          customerDetails: customerDetails,
          orderId: `order_${Date.now()}`
        })
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.message);
      }

      console.log("‚úÖ Cashfree order created:", result);

      const cashfree = Cashfree();
      
      const checkoutOptions = {
        paymentSessionId: result.order.payment_session_id,
        returnUrl: "http://localhost:5000/payment/success", 
        redirectTarget: "_self" 
      };

      console.log("üîÑ Opening Cashfree payment window...");

      cashfree.checkout(checkoutOptions).then(function(result) {
        console.log("Cashfree checkout result:", result);
        
        if (result.error) {
          console.error("Payment failed:", result.error);
          showErrorMessage("Payment failed: " + result.error.message);
        } else {
          console.log("Payment successful:", result);
          handleCashfreePaymentSuccess(result, result.order?.order_id);
        }
      }).catch(function(error) {
        console.error("Checkout error:", error);
        showErrorMessage("Payment initiation failed: " + error.message);
      });

    } catch (error) {
      console.error("‚ùå Payment initiation error:", error);
      showErrorMessage("Failed to initiate payment: " + error.message);
      isProcessingPayment = false;
      
      const payButton = document.getElementById('payButton');
      payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
      payButton.disabled = false;
    }
  }

  async function handleCashfreePaymentSuccess(paymentResult, orderId) {
    try {
      console.log("‚úÖ Cashfree payment successful:", paymentResult);
      
      const token = getAuthToken();
      
      const verifyResponse = await fetch('http://localhost:5000/api/payments/verify-payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          order_id: orderId
        })
      });

      const verifyResult = await verifyResponse.json();
      
      if (verifyResult.success) {
        await createOrderWithPayment('cashfree', {
          order_id: orderId,
          payment_id: verifyResult.paymentId
        });
      } else {
        throw new Error("Payment verification failed");
      }
    } catch (error) {
      console.error("‚ùå Payment processing error:", error);
      showErrorMessage("Payment processing failed: " + error.message);
    } finally {
      isProcessingPayment = false;
    }
  }

  async function createOrderWithPayment(paymentMethod, paymentResponse = null) {
    const submitBtn = document.getElementById("submitOrder");
    const submitText = document.getElementById("submitText");
    const spinner = document.querySelector(".loading-spinner");

    try {
      console.log("=== STARTING ORDER CREATION WITH PAYMENT ===");

      const token = getAuthToken();
      if (!token) {
        showErrorMessage("Please login first");
        return;
      }

      if (!cartItems || cartItems.length === 0) {
        showErrorMessage("Your cart is empty");
        return;
      }

      const shippingAddress = getShippingAddress();
      const orderData = {
        shippingAddress: shippingAddress,
        paymentMethod: paymentMethod,
        shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
        items: cartItems,
        paymentResponse: paymentResponse
      };

      console.log("üì¶ Final Order Data:", orderData);

      const response = await fetch("http://localhost:5000/api/orders/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(orderData),
      });

      const responseText = await response.text();
      console.log("üì® Raw Response:", responseText);

      let result;
      try {
        result = JSON.parse(responseText);
      } catch (parseError) {
        console.error("‚ùå JSON Parse Error:", parseError);
        throw new Error("Server returned invalid JSON: " + responseText);
      }

      if (result.success) {
        console.log("‚úÖ ORDER CREATED SUCCESSFULLY! Order ID:", result.order._id);
        
        showSuccessMessage("Order placed successfully! Confirmation email sent.");
        
        if (paymentMethod === 'qr') {
          document.getElementById('paymentSuccessModal').classList.remove('hidden');
        }

        setTimeout(() => {
          window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
        }, paymentMethod === 'qr' ? 3000 : 2000);
      } else {
        throw new Error(result.message || "Failed to create order");
      }
    } catch (err) {
      console.error("üí• FINAL ERROR:", err);
      showErrorMessage("Failed to place order: " + err.message);
    } finally {
      submitBtn.disabled = false;
      submitText.textContent = "Complete Order";
      spinner.style.display = "none";
    }
  }

  function setupEventListeners() {
    document.querySelectorAll(".payment-method").forEach((pm) => {
      pm.addEventListener("click", function () {
        document.querySelectorAll(".payment-method").forEach((m) => m.classList.remove("selected"));
        this.classList.add("selected");
        const radio = this.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;
        handlePaymentMethodChange();
      });
    });

    document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
      radio.addEventListener("change", updateOrderSummary);
    });

    document.getElementById('payButton')?.addEventListener('click', async function() {
      const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
      
      if (paymentMethod === 'cod') {
        document.getElementById('checkoutForm').dispatchEvent(new Event('submit'));
      } else if (paymentMethod === 'qr') {
        if (!upiPaymentInitiated) {
          generateUPIQrCode(orderTotals.total);
          this.innerHTML = '<i class="fas fa-check mr-2"></i> Confirm Payment - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          document.getElementById('paymentInstructions').textContent = 'After payment, click to confirm and complete order';
          this.disabled = false;
        } else {
          if (!upiPaymentVerified) {
            const confirmed = confirm(`Have you successfully completed the UPI payment of ‚Çπ${orderTotals.total.toLocaleString()}?\n\nPlease ensure you have:\n‚úÖ Scanned the QR code\n‚úÖ Completed payment in your UPI app\n‚úÖ Received payment confirmation\n\nClick OK only if payment was successful.`);
            
            if (confirmed) {
              upiPaymentVerified = true;
              const submitBtn = document.getElementById("submitOrder");
              const submitText = document.getElementById("submitText");
              const spinner = document.querySelector(".loading-spinner");

              submitBtn.disabled = true;
              submitText.textContent = "Processing...";
              spinner.style.display = "inline-block";

              console.log("‚úÖ Creating UPI QR order...");
              await createOrderWithPayment('qr');
            }
          }
        }
      } else if (paymentMethod === 'cashfree') {
        initiateCashfreePayment();
      }
    });

    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector("nav ul");
    if (hamburger) {
      hamburger.addEventListener("click", () => navMenu.classList.toggle("show"));
    }

    const checkoutForm = document.getElementById("checkoutForm");
    checkoutForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      console.log("üîÑ Form submitted");

      if (!validateForm()) {
        console.log("‚ùå Form validation failed");
        return;
      }

      const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
      if (!paymentMethod) {
        showErrorMessage("Please select a payment method");
        return;
      }

      if (paymentMethod === 'cod' || (paymentMethod === 'qr' && upiPaymentVerified)) {
        const submitBtn = document.getElementById("submitOrder");
        const submitText = document.getElementById("submitText");
        const spinner = document.querySelector(".loading-spinner");

        submitBtn.disabled = true;
        submitText.textContent = "Processing...";
        spinner.style.display = "inline-block";

        console.log(`‚úÖ Creating ${paymentMethod} order...`);
        await createOrderWithPayment(paymentMethod);
        return;
      }
      if (paymentMethod === 'qr' && !upiPaymentVerified) {
        showErrorMessage("Please complete the UPI payment process first. Click 'Show QR Code' and then 'Confirm Payment' after payment.");
        return;
      }

      if (paymentMethod === 'cashfree') {
        showErrorMessage("Please click the 'Pay Securely' button to complete your payment.");
        return;
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("üöÄ Checkout page loaded");
    fetchCart();
    setupEventListeners();
    
    setTimeout(() => {
      handlePaymentMethodChange();
    }, 1500);
  });
</script></body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - SaiKrupa Paithani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cashfree SDK -->
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="nav.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#800000",
              primaryLight: "#b30000",
              gold: "#D4AF37",
              lightGold: "#F2E8C9",
              cream: "#F8F4E3",
              darkRed: "#680000",
              gray: "#777",
              lightGray: "#f5f5f5",
              white: "#ffffff",
              black: "#333333",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f4e3;
      }
      .checkout-step {
        transition: all 0.3s ease;
      }
      .checkout-step.active {
        border-color: #d4af37;
        background-color: #f8f4e3;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.95);
        color: #800000;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 15px rgba(128, 0, 0, 0.1);
        height: 80px;
      }
      nav ul {
        display: flex;
        list-style: none;
      }
      nav ul li {
        position: relative;
        margin: 0 15px;
      }
      nav ul li a {
        color: #800000;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        padding: 10px 5px;
        display: block;
        position: relative;
      }
      nav ul li a:after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #800000;
        left: 0;
        bottom: 0;
        transition: width 0.3s ease;
      }
      nav ul li a:hover:after {
        width: 100%;
      }
      .nav-icons {
        display: flex;
        align-items: center;
      }
      .nav-icon {
        color: #800000;
        font-size: 1.3rem;
        margin-left: 20px;
        position: relative;
        cursor: pointer;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #800000;
        color: white;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        margin-left: 20px;
        color: #800000;
      }
      .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .payment-method:hover {
        border-color: #d4af37;
      }
      .payment-method.selected {
        border-color: #800000;
        background-color: #f8f4e3;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 20px;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .step.active .step-number {
        background: #800000;
        color: white;
      }
      .step.completed .step-number {
        background: #d4af37;
        color: white;
      }
      .step-text {
        font-size: 0.9rem;
        color: #777;
      }
      .step.active .step-text {
        color: #800000;
        font-weight: 600;
      }
      .loading-spinner {
        display: none;
      }
      .loading-spinner.active {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .qr-code-container {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        max-width: 280px;
        margin: 0 auto;
      }
      .qrcode svg {
        max-width: 180px !important;
        height: auto !important;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 900px) {
        nav ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          background: rgba(255, 255, 255, 0.98);
          flex-direction: column;
          padding: 20px;
        }
        nav ul.show {
          display: flex;
        }
        nav ul li {
          margin: 10px 0;
          width: 100%;
          text-align: center;
        }
        .hamburger {
          display: block;
        }
        .qr-code-container {
          max-width: 220px;
          padding: 10px;
        }
        .qrcode svg {
          max-width: 150px !important;
        }
      }
    </style>
</head>
<body class="bg-cream">

    <nav>
      <a href="dashboard.html" class="logo flex items-center font-bold text-darkRed">
        <img src="images/logo3.png" alt="Paithani Logo" class="logo-img h-20 w-20 rounded-full mr-3" />
        <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
      </a>
      <ul>
          <li><a href="dashboard.html">Home</a></li>
        <li><a href="product.html">Collections</a></li>
        <li><a href="#testimonials">Testimonials</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-icons">
        <a href="history.html"><div class="nav-icon"><i class="fas fa-shipping-fast mr-2"></i></div></a>
        <div class="nav-icon">
          <a href="cart.html"
            ><i class="fas fa-shopping-cart"></i
            ><span class="cart-count" id="headerCartCount">0</span></a
          >
        </div>
        <div class="hamburger">&#9776;</div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-4 text-gray">
      <a href="dashboard.html"
        ><span class="hover:text-primary cursor-pointer">Home</span> /
      </a>
      <a href="cart.html"
        ><span class="hover:text-primary cursor-pointer">Cart</span> /
      </a>
      <span class="text-primary">Checkout</span>
    </div>

    <div class="container mx-auto px-6 py-6">
      <div class="step-indicator">
        <div class="step completed">
          <div class="step-number"><i class="fas fa-check"></i></div>
          <div class="step-text">Cart</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-text">Information</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-text">Shipping</div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-text">Payment</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Checkout</h1>
      <p class="text-gray mb-8">Complete your purchase with secure checkout</p>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <form id="checkoutForm">
           
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step active">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">1</div>
                <h2 class="text-xl font-semibold text-primary">Contact Information</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
                <div>
                  <label for="phone" class="block text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required />
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="newsletter" class="mr-2" />
                <label for="newsletter" class="text-gray-700">Email me with news and offers</label>
              </div>
            </div>

            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">2</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Address</h2>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="firstName" class="block text-gray-700 mb-2">First Name *</label><input type="text" id="firstName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="lastName" class="block text-gray-700 mb-2">Last Name *</label><input type="text" id="lastName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div class="md:col-span-2"><label for="address" class="block text-gray-700 mb-2">Address *</label><input type="text" id="address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div><label for="city" class="block text-gray-700 mb-2">City *</label><input type="text" id="city" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
                <div>
                  <label for="state" class="block text-gray-700 mb-2">State *</label>
                  <select id="state" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <option value="">Select State</option>
                    <option value="MH">Maharashtra</option>
                    <option value="DL">Delhi</option>
                    <option value="KA">Karnataka</option>
                    <option value="TN">Tamil Nadu</option>
                    <option value="GJ">Gujarat</option>
                    <option value="UP">Uttar Pradesh</option>
                    <option value="WB">West Bengal</option>
                  </select>
                </div>
                <div><label for="pincode" class="block text-gray-700 mb-2">PIN Code *</label><input type="text" id="pincode" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required /></div>
              </div>
              <div class="mt-4 flex items-center">
                <input type="checkbox" id="saveAddress" class="mr-2" />
                <label for="saveAddress" class="text-gray-700">Save this information for next time</label>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">3</div>
                <h2 class="text-xl font-semibold text-primary">Shipping Method</h2>
              </div>
              <div class="space-y-4">
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="standard" name="shipping" value="standard" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="standard" class="font-medium">Standard Shipping</label>
                      <p class="text-gray text-sm">5-7 business days ‚Ä¢ ‚Çπ200</p>
                    </div>
                    <span class="font-semibold">‚Çπ200</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="express" name="shipping" value="express" class="mr-3" />
                    <div class="flex-1">
                      <label for="express" class="font-medium">Express Shipping</label>
                      <p class="text-gray text-sm">2-3 business days ‚Ä¢ ‚Çπ500</p>
                    </div>
                    <span class="font-semibold">‚Çπ500</span>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="flex items-center">
                    <input type="radio" id="free" name="shipping" value="free" class="mr-3" />
                    <div class="flex-1">
                      <label for="free" class="font-medium">Free Shipping</label>
                      <p class="text-gray text-sm">7-10 business days ‚Ä¢ Free on orders above ‚Çπ10,000</p>
                    </div>
                    <span class="font-semibold text-green-600">FREE</span>
                  </div>
                </div>
              </div>
            </div>

         
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 checkout-step" id="paymentSection">
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-3">4</div>
                <h2 class="text-xl font-semibold text-primary">Payment Method</h2>
              </div>

              <div class="space-y-4">
             
                <div class="payment-method selected" id="cashfreePayment">
                  <div class="flex items-center">
                    <input type="radio" id="cashfree" name="payment" value="cashfree" class="mr-3" checked />
                    <div class="flex-1">
                      <label for="cashfree" class="font-medium">Secure Payment via Cashfree</label>
                      <p class="text-gray text-sm">Pay securely using Credit/Debit Card, UPI, Net Banking, or Wallet</p>
                      <div class="flex space-x-2 mt-3">
                        <div class="bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">CASHFREE</div>
                        <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                        <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                        <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                        <i class="fab fa-google-pay text-2xl text-gray-500"></i>
                        <i class="fab fa-amazon-pay text-2xl text-gray-500"></i>
                        <i class="fas fa-mobile-alt text-2xl text-gray-500"></i>
                      </div>
                    </div>
                  </div>
                </div>

            
                <div class="payment-method" id="qrPayment">
                  <div class="flex items-center">
                    <input type="radio" id="qr" name="payment" value="qr" class="mr-3" />
                    <div class="flex-1">
                      <label for="qr" class="font-medium">Pay via UPI QR Code</label>
                      <p class="text-gray text-sm">Scan QR code with any UPI app to pay instantly</p>
                      <div id="qrCodeContainer" class="mt-3 hidden">
                        <div class="qr-code-container">
                          <div id="qrcode" class="qrcode mx-auto mb-3"></div>
                          <p class="text-sm text-gray-600 mb-2">Scan this QR code with your UPI app</p>
                          <p class="text-xs text-gray-500 bg-lightGold p-2 rounded" id="upiId">your-upi-id@bank</p>
                          <p class="text-sm font-semibold text-primary mt-2">Amount: ‚Çπ<span id="qrAmount">0</span></p>
                          <button type="button" id="refreshQR" class="text-primary text-sm mt-2 hover:text-darkRed">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh QR Code
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                
                <div class="payment-method" id="codPayment">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment" value="cod" class="mr-3" />
                    <div class="flex-1">
                      <label for="cod" class="font-medium">Cash on Delivery</label>
                      <p class="text-gray text-sm">Pay when you receive your order (Additional ‚Çπ50 COD charges apply)</p>
                    </div>
                  </div>
                </div>
              </div>

           
              <div class="mt-6 p-4 bg-lightGold rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt text-primary text-xl mr-3"></i>
                  <div>
                    <h4 class="font-semibold text-primary">Your payment is secure with Cashfree</h4>
                    <p class="text-sm text-gray">All transactions are encrypted and secure. We do not store your payment details.</p>
                  </div>
                </div>
              </div>

             
              <div id="cashfreeButtonContainer" class="mt-6">
                <button type="button" id="payButton" class="w-full bg-primary hover:bg-darkRed text-white py-4 px-6 rounded-lg font-semibold text-lg flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-lock mr-2"></i>
                  Pay Securely - ‚Çπ<span id="payAmount">0</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2">You will be redirected to Cashfree secure payment page</p>
              </div>

            
              <div id="upiInstructions" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                <h4 class="font-semibold text-blue-800 mb-2">How to pay with UPI QR Code:</h4>
                <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                  <li>Open your UPI app (Google Pay, PhonePe, Paytm, etc.)</li>
                  <li>Tap on 'Scan QR Code'</li>
                  <li>Scan the QR code above</li>
                  <li>Verify the amount and merchant details</li>
                  <li>Enter your UPI PIN to complete payment</li>
                </ol>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <a href="cart.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Cart
              </a>
              <button type="submit" id="submitOrder" class="bg-primary hover:bg-darkRed text-white py-3 px-8 rounded-lg font-semibold text-lg flex items-center">
                <span id="submitText">Complete Order</span>
                <i class="fas fa-lock ml-2"></i>
                <i class="fas fa-spinner loading-spinner ml-2"></i>
              </button>
            </div>
          </form>
        </div>

        <div class="lg:w-1/3">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-primary mb-4">Order Summary</h2>
            <div class="mb-6 max-h-80 overflow-y-auto" id="orderItemsContainer"></div>
            <div class="space-y-3 mb-6" id="orderSummary">
              <div class="flex justify-between">
                <span class="text-gray">Subtotal (<span id="summaryItemCount">0</span> items)</span>
                <span class="font-medium" id="subtotalAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Shipping</span>
                <span class="font-medium" id="shippingAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray">Tax</span>
                <span class="font-medium" id="taxAmount">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-green-600" id="discountSection" style="display: none">
                <span>Discount</span>
                <span id="discountAmount">-‚Çπ0</span>
              </div>
              <div class="flex justify-between text-orange-600" id="codChargesSection" style="display: none">
                <span>COD Charges</span>
                <span id="codChargesAmount">‚Çπ50</span>
              </div>
              <div class="border-t pt-3 flex justify-between text-lg font-bold">
                <span>Total</span>
                <span class="text-primary" id="totalAmount">‚Çπ0</span>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-center mb-3">
                <i class="fas fa-shield-alt text-primary mr-2"></i>
                <span class="text-sm font-medium">100% Secure Checkout</span>
              </div>
              <div class="flex justify-center space-x-4">
                <i class="fab fa-cc-visa text-2xl text-gray-500"></i>
                <i class="fab fa-cc-mastercard text-2xl text-gray-500"></i>
                <i class="fab fa-cc-amex text-2xl text-gray-500"></i>
                <i class="fab fa-cc-paypal text-2xl text-gray-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Need Help?</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <i class="fas fa-phone text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Call Us</p>
                  <p class="text-sm text-gray">+91 98765 43210</p>
                </div>
              </div>
              <div class="flex items-center">
                <i class="fas fa-comments text-primary mr-3"></i>
                <div>
                  <p class="font-medium">Chat with Us</p>
                  <p class="text-sm text-gray">Available 24/7</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-primary text-white mt-12 py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">SaiKrupa Paithani</h3>
            <p class="text-lightGold">Bringing traditional Maharashtrian elegance to your doorstep with authentic handwoven Paithani sarees.</p>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">About Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Collections</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Shipping Policy</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Return Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li><a href="#" class="text-lightGold hover:text-gold">Contact Us</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">FAQs</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Track Order</a></li>
              <li><a href="#" class="text-lightGold hover:text-gold">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-4">Newsletter</h4>
            <p class="text-lightGold mb-4">Subscribe to get special offers and once-in-a-lifetime deals.</p>
            <div class="flex">
              <input type="email" placeholder="Your email" class="px-4 py-2 rounded-l-lg w-full text-black" />
              <button class="bg-gold text-black px-4 py-2 rounded-r-lg font-semibold">Subscribe</button>
            </div>
          </div>
        </div>
        <div class="border-t border-primaryLight mt-8 pt-8 text-center">
          <p>¬© 2025 SaiKrupa Paithani. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script>
      let cartItems = [];
      let orderTotals = {
        subtotal: 0,
        shipping: 0,
        tax: 0,
        discount: 0,
        codCharges: 0,
        total: 0,
      };
      let cashfreeOrderId = null;
      let isProcessingPayment = false;
      let cashfree = null;

      const YOUR_UPI_ID = "rahulbhandge@ybl";
      const BACKEND_URL = "https://saikrupapaithani-3.onrender.com";

      // Initialize Cashfree
      function initializeCashfree() {
        return new Promise((resolve, reject) => {
          try {
            if (window.Cashfree) {
              cashfree = new Cashfree({
                mode: "production"
              });
              console.log("‚úÖ Cashfree initialized successfully");
              resolve(cashfree);
            } else {
              const checkCashfree = setInterval(() => {
                if (window.Cashfree) {
                  clearInterval(checkCashfree);
                  cashfree = new Cashfree({
                    mode: "production"
                  });
                  console.log("‚úÖ Cashfree initialized successfully");
                  resolve(cashfree);
                }
              }, 100);
              
              setTimeout(() => {
                clearInterval(checkCashfree);
                reject(new Error("Cashfree SDK failed to load"));
              }, 5000);
            }
          } catch (error) {
            console.error("‚ùå Cashfree initialization failed:", error);
            reject(error);
          }
        });
      }

      function getAuthToken() {
        return localStorage.getItem("authToken") || localStorage.getItem("token");
      }

      function checkAuth() {
        const token = getAuthToken();
        if (!token) {
          alert("Please login to proceed with checkout");
          window.location.href = "signup_login.html";
          return false;
        }
        return true;
      }

      function showSuccessMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

      function showErrorMessage(msg) {
        const notif = document.createElement("div");
        notif.className = "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
        notif.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>${msg}</span></div>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
      }

      async function fetchCart() {
        if (!checkAuth()) return;

        try {
          const token = getAuthToken();
          console.log("üîÑ Fetching cart data...");

          const res = await fetch(`${BACKEND_URL}/api/cart`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem("authToken");
              localStorage.removeItem("token");
              window.location.href = "signup_login.html";
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const result = await res.json();
          console.log("üì¶ Cart API response:", result);

          if (result.success && result.cart) {
            cartItems = result.cart.items.map((item) => {
              const product = item.productId;
              return {
                productId: product._id,
                name: product.name || "Product",
                image: product.images?.[0] || "images/default.jpg",
                price: item.price || product.price || 0,
                quantity: item.quantity || 1,
              };
            });

            console.log("üõí Processed cart items:", cartItems);

            if (cartItems.length === 0) {
              showErrorMessage("Your cart is empty");
              setTimeout(() => {
                window.location.href = "cart.html";
              }, 2000);
              return;
            }

            renderOrderItems();
            updateOrderSummary();
            updateCartCount();
          } else {
            throw new Error(result.message || "Failed to fetch cart");
          }
        } catch (err) {
          console.error("‚ùå Fetch cart error:", err);
          showErrorMessage("Failed to load cart items: " + err.message);
        }
      }

      function renderOrderItems() {
        const container = document.getElementById("orderItemsContainer");
        container.innerHTML = cartItems.map((item) => {
          const itemTotal = item.price * item.quantity;
          return `
            <div class="flex border-b border-gray-200 py-4">
              <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex items-center justify-center">
                <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-primary">${item.name}</h3>
                <p class="text-gray text-sm">Qty: ${item.quantity}</p>
                <p class="text-primary font-semibold">‚Çπ${itemTotal.toLocaleString()}</p>
              </div>
            </div>
          `;
        }).join("");
      }

      function updateOrderSummary() {
        const subtotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

        const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
        let shipping = 0;
        if (shippingMethod === "express") shipping = 500;
        else if (shippingMethod === "standard") shipping = 200;
        else if (shippingMethod === "free") shipping = subtotal > 10000 ? 0 : 200;

        const tax = Math.round(subtotal * 0.02);
        const discount = subtotal > 5000 ? Math.round(subtotal * 0.1) : 0;
        
        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
        const codCharges = paymentMethod === 'cod' ? 50 : 0;
        
        const total = subtotal + shipping + tax - discount + codCharges;

        orderTotals = { subtotal, shipping, tax, discount, codCharges, total };

        document.getElementById("summaryItemCount").textContent = itemCount;
        document.getElementById("subtotalAmount").textContent = `‚Çπ${subtotal.toLocaleString()}`;
        document.getElementById("shippingAmount").textContent = shipping === 0 ? "FREE" : `‚Çπ${shipping}`;
        document.getElementById("taxAmount").textContent = `‚Çπ${tax.toLocaleString()}`;
        document.getElementById("totalAmount").textContent = `‚Çπ${total.toLocaleString()}`;

        const discountSection = document.getElementById("discountSection");
        const discountAmount = document.getElementById("discountAmount");
        if (discount > 0) {
          discountSection.style.display = "flex";
          discountAmount.textContent = `-‚Çπ${discount.toLocaleString()}`;
        } else {
          discountSection.style.display = "none";
        }

        const codSection = document.getElementById("codChargesSection");
        if (codCharges > 0) {
          codSection.style.display = "flex";
        } else {
          codSection.style.display = "none";
        }

        if (document.getElementById('payAmount')) {
          document.getElementById('payAmount').textContent = total.toLocaleString();
        }
        if (document.getElementById('qrAmount')) {
          document.getElementById('qrAmount').textContent = total.toLocaleString();
        }
      }

      function updateCartCount() {
        const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("headerCartCount").textContent = totalItems;
      }

      function getShippingAddress() {
        return {
          firstName: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          email: document.getElementById("email").value,
          phone: document.getElementById("phone").value,
          address: document.getElementById("address").value,
          city: document.getElementById("city").value,
          state: document.getElementById("state").value,
          pincode: document.getElementById("pincode").value,
        };
      }

      function validateForm() {
        const requiredFields = [
          "email", "phone", "firstName", "lastName", "address", "city", "state", "pincode",
        ];
        for (let field of requiredFields) {
          const el = document.getElementById(field);
          if (!el.value.trim()) {
            showErrorMessage(`Please fill in the ${field}`);
            el.focus();
            return false;
          }
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(document.getElementById("email").value)) {
          showErrorMessage("Invalid email");
          return false;
        }

        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(document.getElementById("phone").value.replace(/\D/g, ""))) {
          showErrorMessage("Invalid 10-digit phone number");
          return false;
        }

        return true;
      }

      function generateQRCode() {
        try {
          const totalAmount = orderTotals.total;
          const upiId = YOUR_UPI_ID;
          
          const upiUrl = `upi://pay?pa=${upiId}&pn=SaiKrupa%20Paithani&am=${totalAmount}&cu=INR&tn=Payment%20for%20Paithani%20Order`;
          
          const qrcodeElement = document.getElementById('qrcode');
          qrcodeElement.innerHTML = '';
          
          const typeNumber = 0;
          const errorCorrectionLevel = 'L';
          const qr = qrcode(typeNumber, errorCorrectionLevel);
          qr.addData(upiUrl);
          qr.make();
          
          qrcodeElement.innerHTML = qr.createImgTag(4, 0);
          
          document.getElementById('upiId').textContent = upiId;
          document.getElementById('qrAmount').textContent = totalAmount.toLocaleString();
          
          console.log("‚úÖ QR code generated successfully");
          
        } catch (error) {
          console.error("‚ùå QR code error:", error);
          const qrcodeElement = document.getElementById('qrcode');
          qrcodeElement.innerHTML = `
            <div class="text-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
              <p class="text-green-600 font-semibold mb-2">Manual UPI Payment</p>
              <p class="text-sm mb-1">Send payment to:</p>
              <p class="font-mono bg-gray-100 p-2 rounded text-sm font-bold border">${YOUR_UPI_ID}</p>
              <p class="text-md font-semibold text-primary mt-2">Amount: ‚Çπ${orderTotals.total.toLocaleString()}</p>
            </div>
          `;
        }
      }

      function handlePaymentMethodChange() {
        const selectedMethod = document.querySelector('input[name="payment"]:checked').value;
        
        if (selectedMethod === 'cashfree') {
            document.getElementById('cashfreeButtonContainer').classList.remove('hidden');
            document.getElementById('qrCodeContainer').classList.add('hidden');
            document.getElementById('upiInstructions').classList.add('hidden');
        } else if (selectedMethod === 'qr') {
            document.getElementById('cashfreeButtonContainer').classList.add('hidden');
            document.getElementById('qrCodeContainer').classList.remove('hidden');
            document.getElementById('upiInstructions').classList.remove('hidden');
            generateQRCode();
        } else if (selectedMethod === 'cod') {
            document.getElementById('cashfreeButtonContainer').classList.add('hidden');
            document.getElementById('qrCodeContainer').classList.add('hidden');
            document.getElementById('upiInstructions').classList.add('hidden');
        }
        
        updateOrderSummary();
      }

      // ‚úÖ CORRECTED: Payment initiation function
      async function initiateCashfreePayment() {
        if (isProcessingPayment) return;
        
        try {
          isProcessingPayment = true;
          const payButton = document.getElementById('payButton');
          const originalText = payButton.innerHTML;
          
          payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
          payButton.disabled = true;

          if (!validateForm()) {
            isProcessingPayment = false;
            payButton.innerHTML = originalText;
            payButton.disabled = false;
            return;
          }

          // Ensure Cashfree is initialized
          if (!cashfree) {
            await initializeCashfree();
          }

          const token = getAuthToken();
          const customerDetails = {
            customer_id: getUserId(),
            customer_name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
            customer_email: document.getElementById('email').value,
            customer_phone: document.getElementById('phone').value
          };

          console.log("üí∞ Creating Cashfree order for amount:", orderTotals.total);

          const response = await fetch(`${BACKEND_URL}/api/payments/create-order`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              amount: orderTotals.total,
              currency: 'INR',
              customerDetails: customerDetails
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå Server error response:", errorText);
            throw new Error(`Server error: ${response.status} - ${errorText}`);
          }

          const result = await response.json();
          
          console.log("üìÑ Full backend response:", result);
          
          if (!result.success) {
            throw new Error(result.message || 'Failed to create payment order');
          }

          console.log("‚úÖ Cashfree order created:", result);

          // ‚úÖ IMPROVED: Handle different response structures
          let paymentSessionId = null;
          let orderId = null;

          if (result.order && result.order.payment_session_id) {
            paymentSessionId = result.order.payment_session_id;
            orderId = result.order.order_id;
          } else if (result.payment_session_id) {
            paymentSessionId = result.payment_session_id;
            orderId = result.order_id;
          } else {
            console.error("‚ùå Could not find payment_session_id in response:", result);
            throw new Error('Payment session ID not found in server response');
          }

          if (!paymentSessionId) {
            throw new Error('Payment session ID is empty or invalid');
          }

          console.log("üéØ Payment session ID found:", paymentSessionId);

          const checkoutOptions = {
            paymentSessionId: paymentSessionId,
            returnUrl: `https://saikrupapaithani-3.onrender.com/checkout.html?order_id=${orderId}`,
            redirectTarget: "_modal",
            mode: "production"
          };

          console.log("üöÄ Opening Cashfree checkout...");
          
          const checkoutResult = await cashfree.checkout(checkoutOptions);
          console.log("üí∞ Checkout result:", checkoutResult);
          
          if (checkoutResult && checkoutResult.error) {
            throw new Error(checkoutResult.error.message || 'Payment window closed');
          }
          
        } catch (error) {
          console.error("‚ùå Cashfree payment initiation error:", error);
          showErrorMessage("Failed to initiate payment: " + error.message);
        } finally {
          isProcessingPayment = false;
          const payButton = document.getElementById('payButton');
          payButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Pay Securely - ‚Çπ<span id="payAmount">' + orderTotals.total.toLocaleString() + '</span>';
          payButton.disabled = false;
        }
      }

      // Get user ID
      function getUserId() {
        return localStorage.getItem('userId') || 'guest_user';
      }

      // Handle payment return
      async function handlePaymentReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');
        
        if (orderId) {
          try {
            showSuccessMessage("Payment completed! Verifying your payment...");
            
            const token = getAuthToken();
            const response = await fetch(`${BACKEND_URL}/api/payments/verify`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                order_id: orderId,
                orderData: {
                  shippingAddress: getShippingAddress(),
                  paymentMethod: 'cashfree',
                  shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
                  items: cartItems
                }
              })
            });

            const result = await response.json();
            
            if (result.success) {
              showSuccessMessage("Payment verified successfully! Creating your order...");
              
              setTimeout(() => {
                window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
              }, 2000);
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            console.error("‚ùå Payment verification error:", error);
            showErrorMessage("Payment verification failed: " + error.message);
          }
        }
      }

      async function createOrderWithPayment(paymentMethod, paymentResponse = null) {
        const submitBtn = document.getElementById("submitOrder");
        const submitText = document.getElementById("submitText");
        const spinner = document.querySelector(".loading-spinner");

        try {
          console.log("=== STARTING ORDER CREATION WITH PAYMENT ===");

          const token = getAuthToken();
          if (!token) {
            showErrorMessage("Please login first");
            return;
          }

          if (!cartItems || cartItems.length === 0) {
            showErrorMessage("Your cart is empty");
            return;
          }

          const shippingAddress = getShippingAddress();
          const orderData = {
            shippingAddress: shippingAddress,
            paymentMethod: paymentMethod,
            shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
            items: cartItems,
            paymentResponse: paymentResponse 
          };

          console.log("üì¶ Final Order Data:", orderData);

          const response = await fetch(`${BACKEND_URL}/api/orders/create`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });

          const result = await response.json();

          if (result.success) {
            console.log("‚úÖ ORDER CREATED SUCCESSFULLY! Order ID:", result.order._id);
            showSuccessMessage("Order placed successfully!");

            setTimeout(() => {
              window.location.href = `confirmation.html?order_id=${result.order._id}&order_number=${result.order.orderNumber}`;
            }, 2000);
          } else {
            throw new Error(result.message || "Failed to create order");
          }
        } catch (err) {
          console.error("üí• FINAL ERROR:", err);
          showErrorMessage("Failed to place order: " + err.message);
        } finally {
          submitBtn.disabled = false;
          submitText.textContent = "Complete Order";
          spinner.style.display = "none";
        }
      }

      async function createOrder(paymentMethod) {
        await createOrderWithPayment(paymentMethod);
      }

      function setupEventListeners() {
        document.querySelectorAll(".payment-method").forEach((pm) => {
          pm.addEventListener("click", function () {
            document.querySelectorAll(".payment-method").forEach((m) => m.classList.remove("selected"));
            this.classList.add("selected");
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            handlePaymentMethodChange();
          });
        });

        document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
          radio.addEventListener("change", updateOrderSummary);
        });

        document.getElementById('payButton')?.addEventListener('click', initiateCashfreePayment);

        document.getElementById('refreshQR')?.addEventListener('click', generateQRCode);

        const hamburger = document.querySelector(".hamburger");
        const navMenu = document.querySelector("nav ul");
        if (hamburger) {
          hamburger.addEventListener("click", () => navMenu.classList.toggle("show"));
        }

        const checkoutForm = document.getElementById("checkoutForm");
        checkoutForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("üîÑ Form submitted - Starting order process");

          if (!validateForm()) {
            console.log("‚ùå Form validation failed");
            return;
          }

          const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
          if (!paymentMethod) {
            showErrorMessage("Please select a payment method");
            return;
          }

          // For Cashfree and QR payments, handle them separately
          if (paymentMethod === 'cashfree' || paymentMethod === 'qr') {
            if (paymentMethod === 'cashfree') {
              initiateCashfreePayment();
            }
            // For QR payments, we'll create the order directly since payment is manual
            if (paymentMethod === 'qr') {
              const submitBtn = document.getElementById("submitOrder");
              const submitText = document.getElementById("submitText");
              const spinner = document.querySelector(".loading-spinner");

              submitBtn.disabled = true;
              submitText.textContent = "Processing...";
              spinner.style.display = "inline-block";

              await createOrder('qr');
            }
            return;
          }

          // For COD, proceed normally
          const submitBtn = document.getElementById("submitOrder");
          const submitText = document.getElementById("submitText");
          const spinner = document.querySelector(".loading-spinner");

          submitBtn.disabled = true;
          submitText.textContent = "Processing...";
          spinner.style.display = "inline-block";

          console.log("‚úÖ Form validated, calling createOrder for COD...");
          await createOrder(paymentMethod);
        });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("üöÄ Checkout page loaded");
        
        // Initialize Cashfree with proper error handling
        try {
          await initializeCashfree();
          console.log("‚úÖ Cashfree SDK ready");
        } catch (error) {
          console.error("‚ùå Failed to initialize Cashfree:", error);
          showErrorMessage("Payment system not available. Please try another payment method.");
        }
        
        // Check for payment return
        handlePaymentReturn();
        
        fetchCart();
        setupEventListeners();
        
        setTimeout(() => {
          handlePaymentMethodChange();
        }, 1500);
      });
    </script>
</body>
</html>